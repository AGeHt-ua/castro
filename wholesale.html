<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–û–ø—Ç–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑–±—Ä–æ—ó ‚Ä¢ CASTRO</title>
  <style>
    :root{
      --bg0:#07070b;
      --bg1:#0b0b10;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.035);
      --stroke:rgba(255,255,255,.10);
      --strokeSoft:rgba(255,255,255,.08);
      --text:#f3f3f6;
      --muted:rgba(243,243,246,.72);
      --red:#e0182d;
      --redGlow:rgba(224,24,45,.22);
      --shadow: 0 18px 70px rgba(0,0,0,.55);
      --r:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: radial-gradient(900px 520px at 20% 10%, rgba(224,24,45,.18), transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow-x:hidden;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:22px 16px 60px}
    .top{
      display:flex;gap:14px;align-items:center;justify-content:space-between;
      margin:10px 0 16px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;align-items:center;gap:12px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: radial-gradient(120% 120% at 30% 25%, rgba(224,24,45,.55), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 30px rgba(0,0,0,.45);
    }
    h1{margin:0;font-size:1.25rem;letter-spacing:.2px}
    .sub{margin:2px 0 0;color:var(--muted);font-weight:600;font-size:.95rem}

    .grid{display:grid;grid-template-columns: 1.2fr .8fr; gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr; } }

    .card{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid var(--strokeSoft);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background: rgba(224,24,45,.12);
      border:1px solid rgba(224,24,45,.35);
      font-weight:900;font-size:.92rem;
    }
    .content{padding:14px}
    .muted{color:var(--muted)}
    .row{display:grid;grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width: 620px){ .row{grid-template-columns:1fr} }

    label{display:block;font-weight:900;margin:0 0 6px}
    .inp, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      font-weight:700;
    }
    textarea{min-height:90px;resize:vertical}
    .hint{margin:6px 0 0;font-size:.85rem;color:rgba(243,243,246,.62);font-weight:700}

    .section{
      padding:12px;
      border-radius:18px;
      border:1px dashed rgba(255,255,255,.14);
      background: rgba(0,0,0,.12);
      margin-top:10px;
    }

    .cats{display:flex; flex-wrap:wrap; gap:10px}
    .chip{
      cursor:pointer; user-select:none;
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-weight:900;
      transition:.18s;
    }
    .chip:hover{transform:translateY(-1px)}
    .chip.active{
      border-color: rgba(224,24,45,.55);
      background: rgba(224,24,45,.12);
      box-shadow: 0 10px 28px rgba(224,24,45,.10);
    }

    .items{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 980px){ .items{grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 520px){ .items{grid-template-columns: 1fr; } }

    .item{
      cursor:pointer; user-select:none;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      overflow:hidden;
      transition:.18s;
      min-height:164px;
      display:flex; flex-direction:column;
    }
    .item:hover{transform:translateY(-2px)}
    .item.active{
      border-color: rgba(224,24,45,.55);
      box-shadow: 0 16px 34px rgba(224,24,45,.14);
      background: rgba(224,24,45,.08);
    }
    .thumb{
      height:88px;
      display:flex;align-items:center;justify-content:center;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.08));
      border-bottom:1px solid rgba(255,255,255,.07);
      padding:10px;
    }
    .thumb img{
      max-height:64px;max-width:100%;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.5));
    }
    .itm-body{padding:10px 10px 12px; display:flex; flex-direction:column; gap:6px;}
    .itm-title{font-weight:1000}
    .price{font-weight:1000;color:#fff}
    .price small{color:rgba(243,243,246,.7);font-weight:900}

    .qty-grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:8px;
      margin-top:8px;
    }
    @media (max-width: 520px){ .qty-grid{grid-template-columns: repeat(2, minmax(0,1fr)); } }

    .qty{
      cursor:pointer; user-select:none;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      padding:10px 10px;
      text-align:center;
      font-weight:1000;
      transition:.18s;
      line-height:1.15;
    }
    .qty:hover{transform:translateY(-1px)}
    .qty.active{
      border-color: rgba(224,24,45,.55);
      background: rgba(224,24,45,.12);
      box-shadow: 0 10px 26px rgba(224,24,45,.12);
    }
    .qty .d{display:block;font-size:.85rem;color:rgba(243,243,246,.72);font-weight:900;margin-top:4px}

    .receipt{
      display:flex;flex-direction:column;gap:10px;
    }
    .line{
      display:flex;justify-content:space-between;gap:10px;
      font-weight:900;
      color:rgba(243,243,246,.9);
    }
    .line span:last-child{font-weight:1000}
    .sep{height:1px;background:rgba(255,255,255,.10);margin:2px 0}
    .total{
      padding:12px;border-radius:18px;
      border:1px solid rgba(224,24,45,.40);
      background: rgba(224,24,45,.10);
      box-shadow: 0 14px 40px rgba(224,24,45,.10);
    }
    .total .line{font-size:1.1rem}

    .btn{
      cursor:pointer;
      width:100%;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color:var(--text);
      font-weight:1000;
      transition:.18s;
    }
    .btn:hover{transform:translateY(-2px)}
    .btn.primary{
      background: linear-gradient(180deg, rgba(224,24,45,.95), rgba(224,24,45,.70));
      border-color: rgba(224,24,45,.65);
      box-shadow: 0 18px 45px rgba(224,24,45,.22);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed;transform:none}

    .status{
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      font-weight:900;
      color:rgba(243,243,246,.85);
      white-space:pre-wrap;
    }

    .small{font-size:.88rem}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <a href="index.html" class="back-btn">‚Üê –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
      <div class="brand">
        <div class="logo">
          <img src="assets/hero.gif" alt="CASTRO">
        </div>
        <div>
          <h1>–û–ø—Ç–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑–±—Ä–æ—ó ‚Ä¢ <span style="color:var(--red)">CASTRO</span></h1>
          <div class="sub">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è ‚Üí –¢–æ–≤–∞—Ä (–∑ —Ñ–æ—Ç–æ) ‚Üí –ö—ñ–ª—å–∫—ñ—Å—Ç—å (–∑—ñ –∑–Ω–∏–∂–∫–∞–º–∏) ‚Üí –ß–µ–∫ ‚Üí –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –≤ Discord</div>
        </div>
      </div>
      <div class="badge">üßæ –ê–≤—Ç–æ-—á–µ–∫ ‚Ä¢ üí∏ –ó–Ω–∏–∂–∫–∏ ‚Ä¢ üì© Discord</div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="hd">
          <div style="font-weight:1000">üìù –î–∞–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</div>
          <div class="muted small">* –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤—ñ –ø–æ–ª—è</div>
        </div>
        <div class="content">

          <div class="row">
            <div>
              <label for="nick">üíã –í–∞—à –ù—ñ–∫–Ω–µ–π–º | Static ID: *</label>
              <input id="nick" class="inp" placeholder="–ù–∞–ø—Ä: Dominic Castro | 12279" />
              <div class="hint">–Ø–∫ —É –≥—Ä—ñ: Nick | Static ID</div>
            </div>
            <div>
              <label for="disc">üßë‚Äçüíª –í–∞—à Discord: *</label>
              <input id="disc" class="inp" placeholder="–ù–∞–ø—Ä: castro.ua" />
              <div class="hint">–ë–µ–∑ @ ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω—ñ–∫</div>
            </div>
          </div>

          <div class="section">
            <label>üìå –ö–∞—Ç–µ–≥–æ—Ä—ñ—è: *</label>
            <div id="cats" class="cats"></div>
            <div class="hint">–ü—ñ—Å–ª—è –≤–∏–±–æ—Ä—É –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –≤—ñ–¥–∫—Ä–∏—î—Ç—å—Å—è —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä—ñ–≤ (–∫–∞—Ä—Ç–∫–∞–º–∏).</div>
          </div>

          <div id="itemsWrap" class="section" style="display:none">
            <label>üõí –û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä: *</label>
            <div id="items" class="items"></div>
            <div class="hint">–ö–ª—ñ–∫ –ø–æ –∫–∞—Ä—Ç—Ü—ñ ‚Äî –≤–∏–±—ñ—Ä —Ç–æ–≤–∞—Ä—É.</div>
          </div>

          <div id="qtyWrap" class="section" style="display:none">
            <label>üì¶ –ö—ñ–ª—å–∫—ñ—Å—Ç—å (–∑—ñ –∑–Ω–∏–∂–∫–æ—é): *</label>
            <div id="qtyGrid" class="qty-grid"></div>
            <div id="qtyHint" class="hint"></div>
          </div>

          <div id="armorWrap" class="section" style="display:none">
            <label for="armorColor">üé® –ö–æ–ª—ñ—Ä –±—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç—É (—Ç–µ–∫—Å—Ç–æ–º): *</label>
            <input id="armorColor" class="inp" placeholder="–ù–∞–ø—Ä: —á–æ—Ä–Ω–∏–π / —Ç–µ–º–Ω–æ-—Å—ñ—Ä–∏–π / —á–µ—Ä–≤–æ–Ω–∏–π" />
            <div class="hint">–î–ª—è –±—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç—É –∫–æ–ª—ñ—Ä ‚Äî –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ.</div>
          </div>

          <div class="section">
            <label for="delivery">üöö –°–ø–æ—Å—ñ–± –æ—Ç—Ä–∏–º–∞–Ω–Ω—è:</label>
            <select id="delivery">
              <option value="–°–∞–º–æ–≤–∏–≤—ñ–∑">–°–∞–º–æ–≤–∏–≤—ñ–∑</option>
              <option value="–î–æ—Å—Ç–∞–≤–∫–∞ (–∑—É—Å—Ç—Ä—ñ—á)">–î–æ—Å—Ç–∞–≤–∫–∞ (–∑—É—Å—Ç—Ä—ñ—á)</option>
              <option value="–ü–æ—à—Ç–∞">–ü–æ—à—Ç–∞</option>
            </select>
            <div class="hint">–Ø–∫—â–æ ‚Äú–ü–æ—à—Ç–∞‚Äù ‚Äî –Ω–∞–ø–∏—à–∏ –Ω–∏–∂—á–µ –∞–¥—Ä–µ—Å—É/–≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è.</div>

            <div style="height:10px"></div>
            <label for="note">üó∫Ô∏è –î–µ –∑–Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å / –¥–µ—Ç–∞–ª—ñ (–Ω–µ–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ):</label>
            <textarea id="note" placeholder="–ù–∞–ø—Ä: Los Santos, –±—ñ–ª—è –±–∞–Ω–∫—É / –∞–±–æ –ü–æ—à—Ç–∞ ‚Ññ..., —Ä–∞–π–æ–Ω..., —á–∞—Å..."></textarea>
          </div>

        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="hd">
          <div style="font-weight:1000">üßæ –ß–µ–∫</div>
          <div class="muted small mono" id="orderId">order_id: ‚Äî</div>
        </div>
        <div class="content">
          <div class="receipt">
            <div class="line"><span>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</span><span id="rCat">‚Äî</span></div>
            <div class="line"><span>–¢–æ–≤–∞—Ä</span><span id="rItem">‚Äî</span></div>
            <div class="line"><span>–¶—ñ–Ω–∞ –∑–∞ 1</span><span id="rUnit">‚Äî</span></div>
            <div class="line"><span>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</span><span id="rQty">‚Äî</span></div>
            <div class="sep"></div>
            <div class="line"><span>–°—É–º–∞</span><span id="rSub">‚Äî</span></div>
            <div class="line"><span>–ó–Ω–∏–∂–∫–∞</span><span id="rDisc">‚Äî</span></div>
            <div class="sep"></div>
            <div class="total">
              <div class="line"><span>–î–æ —Å–ø–ª–∞—Ç–∏</span><span id="rTotal">‚Äî</span></div>
            </div>

            <button id="sendBtn" class="btn primary" disabled>üì© –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤ Discord</button>

            <div id="status" class="status">–ó–∞–ø–æ–≤–Ω–∏ –ø–æ–ª—è –∑–ª—ñ–≤–∞, –≤–∏–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é ‚Üí —Ç–æ–≤–∞—Ä ‚Üí –∫—ñ–ª—å–∫—ñ—Å—Ç—å.</div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
/* ==========================
   CONFIG (–≤—Å—Ç–∞–≤ —Å–≤–æ—î)
========================== */
const CONFIG = {
  ENDPOINT_URL: "https://odd-night-e9f6.d-f-12339.workers.dev", // ‚Üê —Ç–≤—ñ–π Worker endpoint
  AUTH_HEADER_NAME: "X-Auth",
  AUTH_SECRET: "CASTRO_FORM_2026!9xQp", // ‚Üê —Ç–æ–π —Å–∞–º–∏–π —Å–µ–∫—Ä–µ—Ç, —â–æ –≤ Worker env.FORM_SECRET
  TIMEOUT_MS: 15000
};

/* ==========================
   DATA (–∫–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä—ñ–≤)
   img: –≤—Å—Ç–∞–≤ —Å–≤–æ—ó URL –∞–±–æ assets/...
========================== */
const CATALOG = {
  "–í–æ–≥–Ω–µ–ø–∞–ª—å–Ω–∞ –∑–±—Ä–æ—è": [
    { id:"pistol", name:"Pistol", price:8500, img:"guns/combat-pistol.png" },
    { id:"machine_pistol", name:"Machine Pistol", price:23000, img:"guns/machine-pistol.png" },
    { id:"pump_shotgun", name:"Pump Shotgun", price:25000, img:"guns/pump-shotgun.png" },
    { id:"combat_pdw", name:"Combat PDW", price:33500, img:"guns/combat-pdw.png" },
    { id:"assault_smg", name:"Assault SMG", price:35000, img:"guns/assault-smg.png" },
    { id:"bullpup_rifle", name:"Bullpup Rifle", price:37500, img:"guns/bullpup-rifle.png" },
    { id:"heavy_shotgun", name:"Heavy Shotgun", price:60000, img:"guns/heavy-shotgun.png" },
    { id:"mini_smg", name:"Mini SMG", price:32500, img:"guns/mini-smg.png" },
    { id:"special_carbine", name:"Special Carbine", price:60500, img:"guns/special-carbine.png" },
    { id:"special_carbine_mk2", name:"Special Carbine Mk II", price:65500, img:"guns/special-carbine-mk2.png" },
    { id:"carbine_rifle", name:"Carbine Rifle", price:30500, img:"guns/carbine-rifle.png" },
    { id:"pump_shotgun_mk2", name:"Pump Shotgun Mk II", price:27500, img:"guns/pump-shotgun-mk2.png" },
    { id:"heavy_revolver", name:"Heavy Revolver", price:35500, img:"guns/heavy-revolver.png" }
  ],
  "–•–æ–ª–æ–¥–Ω–∞ –∑–±—Ä–æ—è": [
    { id:"folding_knife", name:"–°–∫–ª–∞–¥–Ω–∏–π –Ω—ñ–∂", price:3000, img:"guns/knife.png" },
    { id:"hunting_knife", name:"–ú–∏—Å–ª–∏–≤—Å—å–∫–∏–π –Ω—ñ–∂", price:9500, img:"guns/Stilet.png" }
  ],
  "–ë–æ—î–ø—Ä–∏–ø–∞—Å–∏": [
    { id:"ammo_9mm", name:"9mm", price:55, img:"guns/9.png" },
    { id:"ammo_12mm", name:"12mm", price:55, img:"guns/12.png" },
    { id:"ammo_556", name:"5.56mm", price:60, img:"guns/5.png" },
    { id:"ammo_762", name:"7.62mm", price:62, img:"guns/7.png" }
  ],
  "–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç": [
    { id:"armor", name:"–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç", price:9000, img:"guns/armo.png" }
  ]
};

/* ==========================
   DISCOUNTS (–∑ —Ç–≤–æ—ó—Ö —Å–∫—Ä—ñ–Ω—ñ–≤)
========================== */
const DISCOUNTS_WEAPON = [
  { qty: 5,  pct: 0  },
  { qty:10,  pct: 2  },
  { qty:15,  pct: 3  },
  { qty:20,  pct: 4  },
  { qty:25,  pct: 5  },
  { qty:30,  pct: 10 },
  { qty:35,  pct: 15 },
  { qty:40,  pct: 17 },
  { qty:45,  pct: 19 },
  { qty:50,  pct: 20 }
];

const DISCOUNTS_AMMO = [
  { qty:100,  pct: 0  },
  { qty:250,  pct: 4  },
  { qty:500,  pct: 6  },
  { qty:1000, pct: 10 },
  { qty:1500, pct: 15 },
  { qty:2000, pct: 18 },
  { qty:2500, pct: 20 }
];

function money(n){
  const x = Math.round(Number(n) || 0);
  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

/* ==========================
   STATE
========================== */
const state = {
  order_id: `CASTRO-${Date.now().toString(36).toUpperCase()}-${Math.random().toString(36).slice(2,6).toUpperCase()}`,
  category: null,
  item: null,
  qty: null,
  discountPct: 0,
  armorColor: ""
};

const $ = (id) => document.getElementById(id);

/* ==========================
   UI INIT
========================== */
$("orderId").textContent = `order_id: ${state.order_id}`;

const catIcons = {
  "–í–æ–≥–Ω–µ–ø–∞–ª—å–Ω–∞ –∑–±—Ä–æ—è": "üî´",
  "–•–æ–ª–æ–¥–Ω–∞ –∑–±—Ä–æ—è": "üó°Ô∏è",
  "–ë–æ—î–ø—Ä–∏–ø–∞—Å–∏": "üì¶",
  "–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç": "üõ°Ô∏è"
};

function renderCats(){
  const wrap = $("cats");
  wrap.innerHTML = "";
  Object.keys(CATALOG).forEach(cat=>{
    const btn = document.createElement("div");
    btn.className = "chip";
    btn.innerHTML = `${catIcons[cat] || "üìå"} <span>${cat}</span>`;
    btn.onclick = () => selectCategory(cat);
    wrap.appendChild(btn);
  });
}

function selectCategory(cat){
  state.category = cat;
  state.item = null;
  state.qty = null;
  state.discountPct = 0;
  state.armorColor = "";
  $("armorColor").value = "";

  // active chip
  [...$("cats").children].forEach(ch=>{
    ch.classList.toggle("active", ch.textContent.includes(cat));
  });

  $("itemsWrap").style.display = "block";
  $("qtyWrap").style.display = "none";
  $("armorWrap").style.display = (cat === "–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç") ? "block" : "none";

  renderItems();
  updateReceipt();
  setStatus(`–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ${cat}\n–¢–µ–ø–µ—Ä –æ–±–µ—Ä–∏ —Ç–æ–≤–∞—Ä.`);
}

function renderItems(){
  const items = CATALOG[state.category] || [];
  const wrap = $("items");
  wrap.innerHTML = "";

  items.forEach(it=>{
    const card = document.createElement("div");
    card.className = "item";
    card.innerHTML = `
      <div class="thumb">
        <img alt="${it.name}" src="${it.img}"
             onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'muted small\\'>–ù–µ–º–∞—î –∫–∞—Ä—Ç–∏–Ω–∫–∏<br><span class=\\'mono\\'>–∑–∞–º—ñ–Ω–∏—Ç–∏ img —É —Ñ–∞–π–ª—ñ</span></div>';" />
      </div>
      <div class="itm-body">
        <div class="itm-title">${it.name}</div>
        <div class="price">${money(it.price)}$ <small>/ 1 –æ–¥.</small></div>
      </div>
    `;
    card.onclick = () => selectItem(it.id);
    wrap.appendChild(card);
  });
}

function selectItem(itemId){
  const it = (CATALOG[state.category] || []).find(x=>x.id===itemId);
  if(!it) return;
  state.item = it;
  state.qty = null;
  state.discountPct = 0;

  // active item
  [...$("items").children].forEach((c, idx)=>{
    const x = (CATALOG[state.category] || [])[idx];
    c.classList.toggle("active", x && x.id === itemId);
  });

  $("qtyWrap").style.display = "block";
  renderQtyPresets();
  updateReceipt();
  setStatus(`–¢–æ–≤–∞—Ä: ${it.name}\n–¢–µ–ø–µ—Ä –æ–±–µ—Ä–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å (–∑—ñ –∑–Ω–∏–∂–∫–æ—é).`);
}

function getDiscountTable(){
  if(state.category === "–ë–æ—î–ø—Ä–∏–ø–∞—Å–∏") return DISCOUNTS_AMMO;
  // —Ö–æ–ª–æ–¥–Ω–∞, –≤–æ–≥–Ω–µ–ø–∞–ª—å–Ω–∞, –±—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç ‚Äî –∞–Ω–∞–ª–æ–≥—ñ—á–Ω–æ –≤–æ–≥–Ω–µ–ø–∞–ª—å–Ω—ñ–π
  return DISCOUNTS_WEAPON;
}

function renderQtyPresets(){
  const wrap = $("qtyGrid");
  wrap.innerHTML = "";
  const table = getDiscountTable();

  $("qtyHint").textContent = (state.category === "–ë–æ—î–ø—Ä–∏–ø–∞—Å–∏")
    ? "–ó–Ω–∏–∂–∫–∞ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –±–æ—î–ø—Ä–∏–ø–∞—Å—ñ–≤."
    : "–ó–Ω–∏–∂–∫–∞ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –æ–¥–∏–Ω–∏—Ü—å.";

  table.forEach(row=>{
    const b = document.createElement("div");
    b.className = "qty";
    const d = row.pct ? `-${row.pct}%` : "–±–µ–∑ –∑–Ω–∏–∂–∫–∏";
    b.innerHTML = `<div>${row.qty}</div><span class="d">${d}</span>`;
    b.onclick = () => selectQty(row.qty, row.pct);
    wrap.appendChild(b);
  });
}

function selectQty(qty, pct){
  state.qty = qty;
  state.discountPct = pct;

  [...$("qtyGrid").children].forEach((c, idx)=>{
    const t = getDiscountTable()[idx];
    c.classList.toggle("active", t && t.qty === qty);
  });

  updateReceipt();
  setStatus(`‚úÖ –û–±—Ä–∞–Ω–æ\n–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ${state.category}\n–¢–æ–≤–∞—Ä: ${state.item?.name}\n–ö—ñ–ª—å–∫—ñ—Å—Ç—å: ${state.qty}\n–ó–Ω–∏–∂–∫–∞: -${state.discountPct}%`);
}

/* ==========================
   RECEIPT + VALIDATION
========================== */
function calc(){
  const unit = state.item?.price || 0;
  const qty = state.qty || 0;
  const subtotal = unit * qty;
  const disc = Math.round(subtotal * (state.discountPct || 0) / 100);
  const total = subtotal - disc;
  return { unit, qty, subtotal, disc, total, pct: state.discountPct || 0 };
}

function updateReceipt(){
  $("rCat").textContent  = state.category ? state.category : "‚Äî";
  $("rItem").textContent = state.item ? state.item.name : "‚Äî";
  $("rUnit").textContent = state.item ? `${money(state.item.price)}$` : "‚Äî";
  $("rQty").textContent  = state.qty ? `${state.qty}` : "‚Äî";

  const { subtotal, disc, total, pct } = calc();
  $("rSub").textContent   = state.item && state.qty ? `${money(subtotal)}$` : "‚Äî";
  $("rDisc").textContent  = state.item && state.qty ? (pct ? `-${pct}% (${money(disc)}$)` : `0% (0$)`) : "‚Äî";
  $("rTotal").textContent = state.item && state.qty ? `${money(total)}$` : "‚Äî";

  const ok = isValid();
  $("sendBtn").disabled = !ok;
}

function isValid(){
  const nick = $("nick").value.trim();
  const disc = $("disc").value.trim();

  if(!nick || !disc) return false;
  if(!state.category || !state.item || !state.qty) return false;

  if(state.category === "–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç"){
    const c = $("armorColor").value.trim();
    if(!c) return false;
    state.armorColor = c;
  }
  return true;
}

$("nick").addEventListener("input", updateReceipt);
$("disc").addEventListener("input", updateReceipt);
$("armorColor").addEventListener("input", updateReceipt);

/* ==========================
   SEND
========================== */
function setStatus(msg){ $("status").textContent = msg; }

async function sendOrder(){
  if(!isValid()){
    setStatus("‚ùå –ó–∞–ø–æ–≤–Ω–∏ –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤—ñ –ø–æ–ª—è —Ç–∞ –≤–∏–±–µ—Ä–∏ —Ç–æ–≤–∞—Ä/–∫—ñ–ª—å–∫—ñ—Å—Ç—å.");
    return;
  }

  const nick = $("nick").value.trim();
  const disc = $("disc").value.trim();
  const delivery = $("delivery").value;
  const note = $("note").value.trim();

  const sums = calc();

  const payload = {
    order_id: state.order_id,
    created_at: new Date().toISOString(),
    buyer: { nick_static: nick, discord: disc },
    category: state.category,
    item: { id: state.item.id, name: state.item.name, unit_price: state.item.price },
    qty: state.qty,
    discount_pct: sums.pct,
    subtotal: sums.subtotal,
    discount_amount: sums.disc,
    total: sums.total,
    armor_color: (state.category === "–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç") ? state.armorColor : null,
    delivery,
    note
  };

  setStatus("‚è≥ –í—ñ–¥–ø—Ä–∞–≤–ª—è—é –≤ Discord...");

  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), CONFIG.TIMEOUT_MS);

  try{
    const res = await fetch(CONFIG.ENDPOINT_URL, {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        [CONFIG.AUTH_HEADER_NAME]: CONFIG.AUTH_SECRET
      },
      body: JSON.stringify(payload),
      signal: controller.signal
    });

    clearTimeout(t);

    const text = await res.text().catch(()=> "");
    if(!res.ok){
      setStatus(`‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞: ${res.status}\n${text || ""}`.trim());
      return;
    }

    setStatus(`‚úÖ –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ!\norder_id: ${state.order_id}\n–°—É–º–∞ –¥–æ —Å–ø–ª–∞—Ç–∏: ${money(sums.total)}$\n\n–¢–µ–ø–µ—Ä –≤ Discord –º–∞—î –∑‚Äô—è–≤–∏—Ç–∏—Å—å –∑–∞—è–≤–∫–∞ (–∞ –±–æ—Ç –¥–æ–¥–∞—Å—Ç—å –∫–Ω–æ–ø–∫–∏ ‚úÖ/‚ùå).`);
  }catch(err){
    clearTimeout(t);
    setStatus(`‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏.\n${String(err)}`);
  }
}

$("sendBtn").addEventListener("click", sendOrder);

/* INIT */
renderCats();
updateReceipt();
</script>
</body>
</html>
