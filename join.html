<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" type="image/png" href="assets/logo.png" />
  <title>–í—Å—Ç—É–ø —É CASTRO</title>

  <link rel="stylesheet" href="auth.css">
  <link rel="stylesheet" href="join.css">
</head>
  
<body class="page-join">
  <!-- Auth dock -->
  <div id="auth-box" class="auth">
    <button id="auth-login" class="auth__btn" type="button">
      <img class="auth__discord" src="assets/discord.svg" alt="">
      –£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Discord
    </button>

    <div id="auth-user" class="auth__user hidden">
      <img id="auth-avatar" class="auth__avatar" alt="">
      <span id="auth-name" class="auth__name"></span>
      <button id="auth-logout" class="auth__logout" type="button" title="–í–∏–π—Ç–∏">‚éã</button>
    </div>
  </div>

  <!-- Background FX -->
  <div class="bgfx" aria-hidden="true"></div>
  <div class="grain" aria-hidden="true"></div>

<header class="topbar" aria-label="–ù–∞–≤—ñ–≥–∞—Ü—ñ—è">
  <a class="back back--pill" href="index.html">‚Üê –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>

  <div class="topbar__title">
    üìå –í—Å—Ç—É–ø —É
    <span class="castro castro--logo">
      CASTRO
      <img src="assets/hero.gif" alt="CASTRO" class="castroLogo">
    </span>
  </div>

  <div class="topbar__meta">
    <span class="chip">üõ°Ô∏è –ó–∞—Ö–∏—Å—Ç —Ç–æ–∫–µ–Ω–æ–º</span>
  </div>
</header>

  <main class="wrap" role="main">
    <div class="grid">

      <!-- MAIN FORM -->
      <section class="card mainCard" aria-label="–ê–Ω–∫–µ—Ç–∞ –≤—Å—Ç—É–ø—É">
        <header class="head">
            <div class="brandText">
              <h1 class="title">–ê–Ω–∫–µ—Ç–∞ –Ω–∞ –≤—Å—Ç—É–ø —É —Å—ñ–º‚Äô—é <span class="castro">CASTRO</span></h1>
              <p class="sub">
                –ó–∞–ø–æ–≤–Ω—é–π —á–µ—Å–Ω–æ —Ç–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ. –ü—ñ—Å–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∑‚Äô—è–≤–∏—Ç—å—Å—è –∫–Ω–æ–ø–∫–∞ –ø—Ä–∏—î–¥–Ω–∞–Ω–Ω—è –¥–æ Discord.
              </p>
            </div>

          <div class="pillbar" aria-label="–ö–ª—é—á–æ–≤—ñ –∞–∫—Ü–µ–Ω—Ç–∏">
            <span class="pill">‚öîÔ∏è RP-–¥–∏—Å—Ü–∏–ø–ª—ñ–Ω–∞</span>
            <span class="pill">üìå –ö–æ–Ω—Ç—Ä–∞–∫—Ç–∏ ‚Ä¢ –í—ñ–π–Ω–∏ —Å—ñ–º–µ–π</span>
            <span class="pill">üéôÔ∏è –ö–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è</span>
          </div>

          <div class="photoRow" aria-label="–§–æ—Ç–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞">
            <!-- UPLOAD (LEFT) -->
            <div class="photo photo--head">
              <label class="photo__frame" for="charPhoto">
                <img id="charPreview" class="photo__img" alt="">
                <div id="charPlaceholder" class="photo__placeholder">
                  <div class="photo__icon">üì∑</div>
                  <div class="photo__title">–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–æ—Ç–æ –ø–µ—Ä—Å–æ–Ω–∞–∂—É</div>
                  <div class="photo__sub">PNG / JPG / WebP ‚Ä¢ –±–∞–∂–∞–Ω–æ 1:1 –∞–±–æ –ø–æ –ø–æ—è—Å</div>
                  <div class="photo__btn" id="photoPickBtn">–û–±—Ä–∞—Ç–∏ —Ñ–æ—Ç–æ</div>
                </div>
              </label>

              <input
                id="charPhoto"
                name="charPhoto"
                type="file"
                accept="image/png, image/jpeg, image/webp"
              >

              <button type="button" class="photo__remove" id="photoRemove" disabled>
                ‚úñ –ü—Ä–∏–±—Ä–∞—Ç–∏ —Ñ–æ—Ç–æ
              </button>

              <div class="hint" id="photoHint" style="margin-top:10px">
                –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä —Ñ–æ—Ç–æ: <b>5 MB</b>.
              </div>
            </div>

            <!-- INFO (RIGHT) -->
            <aside class="photoInfo photoInfo--left" aria-label="–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Ñ–æ—Ç–æ">
              <h3>‚ÑπÔ∏è –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Ñ–æ—Ç–æ</h3>

              <p class="photoInfo__muted">
                –§–æ—Ç–æ –ø–æ—Ç—Ä—ñ–±–Ω–µ –¥–ª—è –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ç–∞ —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –æ—Å–æ–±–æ–≤–æ—ó —Å–ø—Ä–∞–≤–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.
              </p>

              <ul class="photoInfo__list">
                <li>–Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (IC)</li>
                <li>–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ RP-–∞–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç—ñ</li>
                <li>–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ —Å–ø—ñ–≤–±–µ—Å—ñ–¥–∏ / –Ω–∞–±–æ—Ä—É</li>
                <li>–ü—ñ–¥–≤‚Äô—è–∑–∫–∞ –∑–∞—è–≤–∫–∏ –≤ –∫–∞–¥—Ä–æ–≤–æ–º—É –∫–∞–Ω–∞–ª—ñ</li>
              </ul>

              <div class="photoInfo__note">
                ‚ùó –í–∏–º–æ–≥–∏: –±–µ–∑ –º–∞—Å–æ–∫/—à–æ–ª–æ–º—ñ–≤, —á—ñ—Ç–∫–æ –≤–∏–¥–Ω–æ –æ–±–ª–∏—á—á—è ‚Ä¢ –±–∞–∂–∞–Ω–æ 1:1 –∞–±–æ –ø–æ –ø–æ—è—Å
              </div>
            </aside>
          </div>
        </header>

        <div class="body">
          <form id="joinForm" novalidate>
            <!-- Honeypot -->
            <div class="hp" aria-hidden="true">
              <label>–ù–µ –∑–∞–ø–æ–≤–Ω—é–≤–∞—Ç–∏</label>
              <input name="website" autocomplete="off" tabindex="-1">
            </div>

            <div class="section">
              <h3><span class="dot"></span> –î–∞–Ω—ñ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h3>

              <div class="row">
                <div class="field">
                  <label for="irl">1) –Ü–º‚Äô—è —Ç–∞ –≤—ñ–∫ (IRL)</label>
                  <input id="irl" name="irl" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ê–Ω–¥—Ä—ñ–π, 20" required autocomplete="off">
                </div>

                <div class="field">
                  <label for="nick">2) –í–∞—à –ù—ñ–∫–Ω–µ–π–º | Static ID:</label>
                  <input id="nick" name="nick" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: Dominic Castro | 12279" required autocomplete="off">
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label for="timeOnServer">3) –°–∫—ñ–ª—å–∫–∏ —á–∞—Å—É –≥—Ä–∞—î—à –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ?</label>
                  <select id="timeOnServer" name="timeOnServer" required>
                    <option value="">–û–±–µ—Ä–∏‚Ä¶</option>
                    <option>–ú–µ–Ω—à–µ –º—ñ—Å—è—Ü—è</option>
                    <option>1‚Äì3 –º—ñ—Å—è—Ü—ñ</option>
                    <option>3‚Äì6 –º—ñ—Å—è—Ü—ñ</option>
                    <option>–ü–æ–Ω–∞–¥ 6 –º—ñ—Å—è—Ü—ñ–≤</option>
                  </select>
                </div>

                <div class="field">
                  <label for="hoursPerDay">4) –°–∫—ñ–ª—å–∫–∏ –≥–æ–¥–∏–Ω –≥—Ä–∞—î—à –Ω–∞ –¥–µ–Ω—å?</label>
                  <input id="hoursPerDay" name="hoursPerDay" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 3‚Äì5 –≥–æ–¥–∏–Ω" required autocomplete="off">
                </div>
              </div>
            </div>

            <div class="section">
              <h3><span class="dot"></span> –î–æ—Å–≤—ñ–¥ —Ç–∞ –º–æ—Ç–∏–≤–∞—Ü—ñ—è</h3>

              <div>
                <label for="exp">5) –î–æ—Å–≤—ñ–¥ —É—á–∞—Å—Ç—ñ —É —Å—ñ–º‚Äô—è—Ö/–æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è—Ö</label>
                <textarea id="exp" name="exp" placeholder="–î–µ –±—É–≤(-–ª–∞), —â–æ —Ä–æ–±–∏–≤(-–ª–∞), —á–æ–º—É –ø—ñ—à–æ–≤(-–ª–∞)?" required></textarea>
                <div class="hint">–ß–∏–º —á–µ—Å–Ω—ñ—à–µ —ñ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ—à–µ ‚Äî —Ç–∏–º –∫—Ä–∞—â–µ.</div>
              </div>

              <div class="mt12">
                <label for="why">6) –ß–æ–º—É —Ö–æ—á–µ—à –ø—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è —Å–∞–º–µ –¥–æ CASTRO?</label>
                <textarea id="why" name="why" placeholder="–©–æ –æ—á—ñ–∫—É—î—à –≤—ñ–¥ —Å—ñ–º‚Äô—ó —ñ —â–æ –º–æ–∂–µ—à –¥–∞—Ç–∏ –≤–∑–∞–º—ñ–Ω?" required></textarea>
              </div>

              <div class="mt12">
                <label for="skills">7) –¢–≤–æ—ó —Å–∏–ª—å–Ω—ñ —Å—Ç–æ—Ä–æ–Ω–∏ —è–∫ –≥—Ä–∞–≤—Ü—è</label>
                <textarea id="skills" name="skills" placeholder="RP, —Å—Ç—Ä—ñ–ª—è–Ω–∏–Ω–∞, –≤–æ–¥—ñ–Ω–Ω—è, —Ç–∞–∫—Ç–∏–∫–∞, –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è‚Ä¶" required></textarea>
              </div>
            </div>

            <div class="section">
              <h3><span class="dot"></span> –ó–≤‚Äô—è–∑–æ–∫ —Ç–∞ –ø—Ä–∞–≤–∏–ª–∞</h3>

              <div class="row">
                <div class="field">
                  <label for="mic">8) –ú–∞—î—à –º—ñ–∫—Ä–æ—Ñ–æ–Ω / –∫–æ—Ä–∏—Å—Ç—É—î—à—Å—è –≥–æ–ª–æ—Å–æ–≤–∏–º?</label>
                  <select id="mic" name="mic" required>
                    <option value="">–û–±–µ—Ä–∏‚Ä¶</option>
                    <option>–¢–∞–∫</option>
                    <option>–ù—ñ</option>
                  </select>
                </div>

                <div class="field">
                  <label for="discord">9) Discord:</label>
                  <span for="discord">(–ø–æ—Å–∏–ª–∞–Ω–Ω—è / @–Ω—ñ–∫)</span>
                  <input
                    id="discord"
                    name="discord"
                    placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: @nickname –∞–±–æ nickname#0000 –∞–±–æ <@!1234567890>"
                    required
                    autocomplete="off"
                    spellcheck="false"
                    pattern=".{3,}"
                    title="–í–≤–µ–¥–∏ Discord (–º—ñ–Ω—ñ–º—É–º 3 —Å–∏–º–≤–æ–ª–∏)"
                  >
                  <input type="hidden" name="discordMention" id="discordMention">
                </div>
              </div>

              <div class="row mt12">
                <div class="field">
                  <label for="rules">10) –ì–æ—Ç–æ–≤–∏–π(-–∞) –¥–æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏—Å—å –ø—Ä–∞–≤–∏–ª CASTRO?</label>
                  <select id="rules" name="rules" required>
                    <option value="">–û–±–µ—Ä–∏‚Ä¶</option>
                    <option>–¢–∞–∫, –ø–æ–≤–Ω—ñ—Å—Ç—é</option>
                    <option>–ù—ñ</option>
                    <option>–Ü–Ω—à–µ</option>
                  </select>
                </div>

                <div class="field">
                  <label for="rename">11) –ì–æ—Ç–æ–≤–∏–π(-–∞) –∑–º—ñ–Ω–∏—Ç–∏ –ø—Ä—ñ–∑–≤–∏—â–µ –Ω–∞ CASTRO?</label>
                  <select id="rename" name="rename" required>
                    <option value="">–û–±–µ—Ä–∏‚Ä¶</option>
                    <option>–¢–∞–∫</option>
                    <option>–ù—ñ</option>
                    <option>–Ü–Ω—à–µ</option>
                  </select>
                </div>
              </div>

              <div class="mt12">
                <label for="extra">12) –î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è (–Ω–µ–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ)</label>
                <textarea id="extra" name="extra" placeholder="–ë—É–¥—å-—è–∫—ñ –≤–∞–∂–ª–∏–≤—ñ –¥–µ—Ç–∞–ª—ñ: —á–∞—Å–æ–≤–∏–π –ø–æ—è—Å, –≥—Ä–∞—Ñ—ñ–∫, –Ω–∞–≤–∏—á–∫–∏, –≤—ñ–¥–≥—É–∫–∏‚Ä¶"></textarea>
              </div>
            </div>

            <div class="agree">
              <label class="agree__box">
                <input type="checkbox" id="agreeChk" required>
                <span class="agree__tick" aria-hidden="true"></span>
                <span class="agree__text">
                  –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—é, —â–æ –æ–∑–Ω–∞–π–æ–º–∏–≤—Å—è(-–ª–∞—Å—å) —Ç–∞ –ø–æ–≥–æ–¥–∂—É—é—Å—å —ñ–∑ –ø—Ä–∞–≤–∏–ª–∞–º–∏ —Å—ñ–º‚Äô—ó CASTRO.
                </span>
              </label>

              <details class="agree__details">
                <summary>üìú –í—ñ–¥–∫—Ä–∏—Ç–∏ –ø–æ–≤–Ω–∏–π —Ç–µ–∫—Å—Ç –∑–æ–±–æ–≤‚Äô—è–∑–∞–Ω—å</summary>
                <div class="agree__rules">
                  <p>
                    –ü–æ–≥–æ–¥–∂—É—é—Å—å –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –≤—Å—ñ –≤–∫–∞–∑—ñ–≤–∫–∏ –∫–µ—Ä—ñ–≤–Ω–æ–≥–æ —Å–∫–ª–∞–¥—É. –ü—Ä–∏ –ø–µ—Ä—à–æ–º—É –ø—Ä–æ—Ö–∞–Ω–Ω—ñ –±—Ä–∞—Ç–∏ —É—á–∞—Å—Ç—å —É –≤—ñ–π–Ω—ñ —Å—ñ–º–µ–π —Ç–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ñ–≤.
                    –£ —Ä–∞–∑—ñ –Ω–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –≤–∏–º–æ–≥ ‚Äî –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ–∫–∞—Ä–∞–Ω–Ω—è (—à—Ç—Ä–∞—Ñ, –ø–æ–Ω–∏–∂–µ–Ω–Ω—è –≤ —Ä–∞–Ω–∑—ñ, –∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è).
                    –£ —Ä–∞–∑—ñ –∫—É–ø—ñ–≤–ª—ñ —Å—ñ–º–µ–π–Ω–æ–≥–æ –æ–¥—è–≥—É ‚Äî –Ω–µ –ø—Ä–æ–¥–∞–≤–∞—Ç–∏ —ñ–Ω—à–∏–º –ª—é–¥—è–º.
                    –£ —Ä–∞–∑—ñ —Å–∞–º–æ–≤—ñ–ª—å–Ω–æ–≥–æ –∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è –∑ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó ‚Äî —Å–ø–ª–∞—Ç–∏—Ç–∏ –ø–æ–¥–∞—Ç–æ–∫ 100.000$ —Ç–∞ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –∫—É–ø–ª–µ–Ω–∏–π —Å—ñ–º–µ–π–Ω–∏–π –æ–¥—è–≥.
                  </p>
                </div>
              </details>
            </div>

            <div class="actions" id="actions">
              <button class="btn" type="submit" id="submitBtn" disabled>‚úÖ –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–∞—è–≤–∫—É</button>
              <div class="status" id="status">–£–≤—ñ–π–¥–∏ —á–µ—Ä–µ–∑ Discord —ñ –ø–æ—Å—Ç–∞–≤ –≥–∞–ª–æ—á–∫—É.</div>
            </div>

            <div class="ok" id="ok">
              <h4>‚úÖ –ó–∞—è–≤–∫—É –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ!</h4>
              <p>–ü—Ä–∏—î–¥–Ω—É–π—Å—è –¥–æ Discord –¥–ª—è –∑–≤‚Äô—è–∑–∫—É —Ç–∞ —Ä–æ–∑–≥–ª—è–¥—É –∑–∞—è–≤–∫–∏.</p>
              <a class="discord" id="discordBtn" href="#" target="_blank" rel="noopener">–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –¥–æ Discord</a>
            </div>

            <div class="footer">Family CASTRO ‚Ä¢ Ukraine GTA 5 RP</div>
          </form>
        </div>
      </section>

      <!-- SIDEBAR -->
      <aside class="card side sideCard" aria-label="–ü—ñ–¥–∫–∞–∑–∫–∏ –ø–µ—Ä–µ–¥ –≤—ñ–¥–ø—Ä–∞–≤–∫–æ—é">
        <div class="mini">
          <h3>üìå –ü–µ—Ä–µ–¥ –≤—ñ–¥–ø—Ä–∞–≤–∫–æ—é</h3>
          <p>–¢–≤–æ—è –∑–∞—è–≤–∫–∞ –æ–¥—Ä–∞–∑—É –ø—Ä–∏–ª—ñ—Ç–∞—î —É –∫–∞–¥—Ä–æ–≤–∏–π –∫–∞–Ω–∞–ª Discord. –ü–µ—Ä–µ–≤—ñ—Ä, —â–æ–± Discord –Ω—ñ–∫ –±—É–≤ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π.</p>

          <div class="rule">‚ö†Ô∏è –§–µ–π–∫–æ–≤–∞ / –Ω–µ—è–∫—ñ—Å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è = –≤—ñ–¥–º–æ–≤–∞</div>

          <ul class="list">
            <li>–í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –ø–æ —Å—É—Ç—ñ, –±–µ–∑ ‚Äú–Ω–æ—Ä–º/–æ–∫‚Äù.</li>
            <li>–ü–∏—à–∏ —á–µ—Å–Ω–æ –ø—Ä–æ –¥–æ—Å–≤—ñ–¥ —ñ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ –∑ —ñ–Ω—à–∏–º–∏ —Å—ñ–º‚Äô—è–º–∏.</li>
            <li>–Ø–∫—â–æ –Ω–µ –º–∞—î—à –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞ ‚Äî –∫—Ä–∞—â–µ –≤–∫–∞–∂–∏ –æ–¥—Ä–∞–∑—É.</li>
          </ul>

          <span class="tag">üî• Power in unity</span>
        </div>
      </aside>

    </div>
  </main>

  <script>
    // =========================
    // ‚úÖ –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø
    // =========================
    const WORKER_BASE = "https://winter-cake-f101.d-f-12339.workers.dev";
    const TOKEN_URL   = WORKER_BASE + "/token";
    const SUBMIT_URL  = WORKER_BASE + "/submit";
    const DISCORD_INVITE = "https://discord.gg/Tx4VyZSAjN";

    const MAX_PHOTO_BYTES = 5 * 1024 * 1024; // 5 MB
    const DRAFT_KEY = "castro_join_draft_v1";

    // –ì–ª–æ–±–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó (–∂–∏–≤–∏—Ç—å—Å—è –∑ auth.js)
    window.AUTH_USER = null;

    // =========================
    // ‚úÖ DOM
    // =========================
    const form = document.getElementById("joinForm");
    const statusEl = document.getElementById("status");
    const okEl = document.getElementById("ok");
    const btn = document.getElementById("submitBtn");
    const discordBtn = document.getElementById("discordBtn");
    const agreeChk = document.getElementById("agreeChk");
    const actionsEl = document.getElementById("actions");

    discordBtn.href = DISCORD_INVITE;

    // ‚úÖ –§–æ—Ç–æ
    const photoInput = document.getElementById("charPhoto");
    const previewImg = document.getElementById("charPreview");
    const placeholder = document.getElementById("charPlaceholder");
    const removeBtn = document.getElementById("photoRemove");
    const pickBtn = document.getElementById("photoPickBtn");
    const photoHint = document.getElementById("photoHint");

    let lastObjectUrl = null;

    pickBtn?.addEventListener("click", (e) => {
      e.preventDefault();
      photoInput?.click();
    });

    const revokeLastUrl = () => {
      if (lastObjectUrl) {
        try { URL.revokeObjectURL(lastObjectUrl); } catch {}
        lastObjectUrl = null;
      }
    };

    const clearPhoto = () => {
      revokeLastUrl();
      if (photoInput) photoInput.value = "";
      if (previewImg) {
        previewImg.src = "";
        previewImg.style.display = "none";
      }
      if (placeholder) placeholder.style.display = "grid";
      if (removeBtn) removeBtn.disabled = true;
      if (photoHint) photoHint.textContent = "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä —Ñ–æ—Ç–æ: 5 MB.";
    };

    photoInput?.addEventListener("change", () => {
      const file = photoInput.files?.[0];
      if (!file) return clearPhoto();

      if (!file.type.startsWith("image/")) {
        clearPhoto();
        alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä–∏ —Ñ–∞–π–ª –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (PNG/JPG/WebP).");
        return;
      }

      if (file.size > MAX_PHOTO_BYTES) {
        clearPhoto();
        alert("–§–æ—Ç–æ –∑–∞–≤–µ–ª–∏–∫–µ. –ú–∞–∫—Å–∏–º—É–º 5 MB.");
        return;
      }

      revokeLastUrl();
      lastObjectUrl = URL.createObjectURL(file);

      previewImg.src = lastObjectUrl;
      previewImg.style.display = "block";
      placeholder.style.display = "none";
      removeBtn.disabled = false;

      if (photoHint) photoHint.textContent = "–§–æ—Ç–æ –¥–æ–¥–∞–Ω–æ ‚úÖ";
    });

    removeBtn?.addEventListener("click", clearPhoto);

    // =========================
    // ‚úÖ –ö–ù–û–ü–ö–ê: –≥–∞–ª–æ—á–∫–∞ + –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è
    // =========================
    const syncAgree = () => {
      const agreeOk = !!agreeChk.checked;
      const authOk = !!window.AUTH_USER;

      btn.disabled = !(agreeOk && authOk);

      if (!authOk) statusEl.textContent = "üîê –£–≤—ñ–π–¥–∏ —á–µ—Ä–µ–∑ Discord, —â–æ–± –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–∞—è–≤–∫—É.";
      else statusEl.textContent = agreeOk ? "‚úÖ –ú–æ–∂–µ—à –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ –∑–∞—è–≤–∫—É." : "–ü–æ—Å—Ç–∞–≤ –≥–∞–ª–æ—á–∫—É —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤ –∑–∞—è–≤–∫—É.";
    };

    agreeChk.addEventListener("change", syncAgree);
    syncAgree();

    // üîê –û—Ç—Ä–∏–º—É—î–º–æ —Å—Ç–∞—Ç—É—Å –ª–æ–≥—ñ–Ω—É –∑ auth.js
    window.addEventListener("castro-auth", (e) => {
      window.AUTH_USER = e.detail?.user || null;
      syncAgree();
    });

    // –Ø–∫—â–æ auth.js –≤–∂–µ –≤—Å—Ç–∏–≥ –ø–æ—Å—Ç–∞–≤–∏—Ç–∏ —Å—Ç–∞–Ω (—Ä—ñ–¥–∫–æ, –∞–ª–µ –æ–∫)
    if (window.__CASTRO_AUTH__?.user) {
      window.AUTH_USER = window.__CASTRO_AUTH__.user;
      syncAgree();
    }

    // =========================
    // ‚úÖ –ß–µ—Ä–Ω–µ—Ç–∫–∞ (localStorage)
    // =========================
    const serializeDraft = () => {
      const fd = new FormData(form);
      fd.delete("charPhoto");

      const obj = {};
      for (const [k, v] of fd.entries()) obj[k] = String(v ?? "");
      obj._agree = agreeChk.checked ? "1" : "0";

      localStorage.setItem(DRAFT_KEY, JSON.stringify(obj));
    };

    const restoreDraft = () => {
      try {
        const raw = localStorage.getItem(DRAFT_KEY);
        if (!raw) return;
        const obj = JSON.parse(raw);

        for (const [k, v] of Object.entries(obj)) {
          if (k === "_agree") continue;
          const el = form.querySelector(`[name="${CSS.escape(k)}"]`);
          if (!el) continue;
          el.value = String(v ?? "");
        }
        agreeChk.checked = obj._agree === "1";
        syncAgree();
      } catch {}
    };

    form.addEventListener("input", serializeDraft);
    restoreDraft();

    // =========================
    // ‚úÖ Token
    // =========================
    let submitToken = null;

    const fetchToken = async () => {
      try {
        const res = await fetch(TOKEN_URL, { method: "GET" });
        const json = await res.json().catch(() => null);
        if (!res.ok || !json?.token) throw new Error("token_failed");
        submitToken = json.token;
      } catch {
        submitToken = null;
      }
    };

    fetchToken();

    // =========================
    // ‚úÖ –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫
    // =========================
    const explainError = (res, json) => {
      if (res?.status === 413) return "‚ùå –§–æ—Ç–æ –∑–∞–≤–µ–ª–∏–∫–µ. –°—Ç–∏—Å–Ω–∏ –∞–±–æ –≤–∏–±–µ—Ä–∏ —ñ–Ω—à–µ (–¥–æ 5MB).";
      if (res?.status === 429) return "‚è≥ –ó–∞–±–∞–≥–∞—Ç–æ —Å–ø—Ä–æ–±. –ó–∞—á–µ–∫–∞–π —Ç—Ä–æ—Ö–∏ —ñ –ø–æ–≤—Ç–æ—Ä–∏.";
      if (res?.status === 403) return "‚õî –î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ (–ø–µ—Ä–µ–≤—ñ—Ä, —â–æ –≤—ñ–¥–∫—Ä–∏–≤ –∑ family-castro.fun).";
      if (res?.status === 400) return "‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ñ –¥–∞–Ω—ñ. –ü–µ—Ä–µ–≤—ñ—Ä –ø–æ–ª—è —Ç–∞ —Å–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑.";
      if (json?.error) return "‚ùå " + String(json.error);
      return "‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏. –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑ –∞–±–æ –Ω–∞–ø–∏—à–∏ –∫–µ—Ä—ñ–≤–Ω–∏—Ü—Ç–≤—É.";
    };

    // =========================
    // ‚úÖ –í–∞–ª—ñ–¥–∞—Ü—ñ—è –ø–µ—Ä–µ–¥ —Å–∞–±–º—ñ—Ç–æ–º
    // =========================
    const validateBeforeSubmit = () => {
      const hp = form.querySelector('input[name="website"]');
      if (hp && hp.value.trim()) return { ok: false, msg: "‚õî –í—ñ–¥—Ö–∏–ª–µ–Ω–æ." };

      if (!form.checkValidity()) {
        form.reportValidity();
        return { ok: false, msg: "‚ùå –ó–∞–ø–æ–≤–Ω–∏ –≤—Å—ñ –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤—ñ –ø–æ–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ." };
      }

      if (!agreeChk.checked) return { ok: false, msg: "‚õî –°–ø–æ—á–∞—Ç–∫—É –ø–æ—Å—Ç–∞–≤ –≥–∞–ª–æ—á–∫—É –∑–≥–æ–¥–∏." };
      if (!submitToken) return { ok: false, msg: "‚õî –ù–µ–º–∞—î —Ç–æ–∫–µ–Ω–∞ –∑–∞—Ö–∏—Å—Ç—É. –û–Ω–æ–≤–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É —ñ —Å–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑." };

      return { ok: true };
    };

    // =========================
    // ‚úÖ –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º–∏
    // =========================
    let sending = false;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // üîê AUTH CHECK
      if (!window.AUTH_USER) {
        statusEl.textContent = "‚õî –£–≤—ñ–π–¥–∏ —á–µ—Ä–µ–∑ Discord –ø–µ—Ä–µ–¥ –≤—ñ–¥–ø—Ä–∞–≤–∫–æ—é –∑–∞—è–≤–∫–∏.";
        return;
      }

      if (sending) return;

      const v = validateBeforeSubmit();
      if (!v.ok) {
        statusEl.textContent = v.msg;
        return;
      }

      sending = true;
      btn.disabled = true;
      statusEl.textContent = "‚è≥ –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–∞—è–≤–∫—É‚Ä¶";

      const fd = new FormData(form);

      const file = photoInput?.files?.[0];
      if (file) fd.set("charPhoto", file, file.name);

      fd.set("agree", agreeChk.checked ? "yes" : "no");

      try {
        const res = await fetch(SUBMIT_URL, {
          method: "POST",
          headers: { "X-Token": submitToken },
          body: fd
        });

        const json = await res.json().catch(() => ({}));

        if (!res.ok || !json.ok) {
          statusEl.textContent = explainError(res, json);
          await fetchToken();
          sending = false;
          syncAgree();
          return;
        }

        statusEl.textContent = "‚úÖ –ì–æ—Ç–æ–≤–æ. –ü–µ—Ä–µ–≤—ñ—Ä Discord.";
        okEl.style.display = "block";
        if (actionsEl) actionsEl.style.display = "none";

        localStorage.removeItem(DRAFT_KEY);

        form.reset();
        clearPhoto();

        okEl.scrollIntoView({ behavior: "smooth", block: "start" });

        syncAgree();
        await fetchToken();
      } catch (err) {
        console.error(err);
        statusEl.textContent = "‚ùå –ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ. –ü–µ—Ä–µ–≤—ñ—Ä —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç —ñ —Å–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑.";
        await fetchToken();
        sending = false;
        syncAgree();
        return;
      }

      sending = false;
    });
  </script>

  <!-- ‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó (–≤ –∫—ñ–Ω—Ü—ñ body) -->
  <script src="auth.js"></script>
  <script src="profile.js"></script>

</body>
</html>
