<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–í—ñ–¥–≥—É–∫–∏ ‚Ä¢ CASTRO</title>

  <link rel="icon" type="image/png" href="assets/logo.png" />
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="order.css" />
  <link rel="stylesheet" href="auth.css" />
</head>

<body class="order">

<!-- üîß Profile Settings Modal -->
<div id="profile-modal" class="pmodal hidden" role="dialog" aria-modal="true" aria-labelledby="pmodal-title">
  <div class="pmodal__backdrop" data-close></div>

  <div class="pmodal__card">
    <div class="pmodal__head">
      <h2 id="pmodal-title">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é</h2>
      <button class="pmodal__x" type="button" data-close>‚úï</button>
    </div>

    <div class="pmodal__body">
      <label class="pmodal__label">–ù—ñ–∫–Ω–µ–π–º —É –≥—Ä—ñ (IC)</label>
      <input id="pf-ic" class="pmodal__input" type="text" placeholder="–ù–∞–ø—Ä: Dominic Castro" maxlength="32"/>

      <label class="pmodal__label">Static ID</label>
      <input id="pf-sid" class="pmodal__input" type="text" placeholder="–ù–∞–ø—Ä: 12279" maxlength="12" inputmode="numeric"/>

      <p class="pmodal__hint">–ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —É –±—Ä–∞—É–∑–µ—Ä—ñ (localStorage). –¢—ñ–ª—å–∫–∏ —Ç–∏ —Ü–µ –±–∞—á–∏—à.</p>
    </div>

    <div class="pmodal__actions">
      <button id="pf-save" class="pmodal__btn" type="button">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
      <button class="pmodal__btn pmodal__btn--ghost" type="button" data-close>–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    </div>
  </div>
</div>

<div class="sparks" aria-hidden="true"></div>

<header class="topbar">
  <a class="back back--pill" href="index.html">‚Üê –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>

  <div class="topbar__title">
    üí¨ –í—ñ–¥–≥—É–∫–∏
    <span class="castro castro--logo">
      CASTRO
      <img src="assets/hero.gif" alt="CASTRO" class="castroLogo">
    </span>
  </div>

  <div class="topbar__meta">
    <span class="orderBadge">–ó–∞–ª–∏—à —Å–≤—ñ–π –ø—ñ—Å–ª—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è üôÇ</span>
    <span class="chip">üõ°Ô∏è –ó–∞—Ö–∏—Å—Ç —Ç–æ–∫–µ–Ω–æ–º</span>
  </div>
</header>

<main class="container">

  <!-- –í–£–ó–¨–ö–û + –ü–û –¶–ï–ù–¢–†–£ (CSS –¥–æ–¥–∞—Å–∏ —Å–∞–º) -->
  <div class="reviewsWrapper">
    <div class="reviewsLayout">

      <!-- –§–û–†–ú–ê -->
      <div class="card">
        <div class="hd">
          <div class="hd__title">‚úçÔ∏è –ó–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫</div>
          <div class="muted small">* –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ</div>
        </div>

        <div class="content">
          <div class="row">
            <div>
              <label for="nick">üíã –ù—ñ–∫–Ω–µ–π–º | Static ID: *</label>
              <input id="nick" class="inp" placeholder="–ù–∞–ø—Ä: Dominic Castro | 12279" />
            </div>

            <div>
              <label for="disc">üßë‚Äçüíª Discord: *</label>
              <input id="disc" class="inp" placeholder="–ù–∞–ø—Ä: @castro.ua" />
              <input type="hidden" id="discordMention">
            </div>
          </div>

          <div class="obox">
            <div class="rateRow">
              <div class="rateLeft">
                <span class="rateIcon">‚≠ê</span>
                <span class="rateLabel">–û—Ü—ñ–Ω–∫–∞</span>
              </div>

              <div class="rateRight">
                <div id="rStars" class="star-rating">
                  <span data-val="5">‚òÖ</span>
                  <span data-val="4">‚òÖ</span>
                  <span data-val="3">‚òÖ</span>
                  <span data-val="2">‚òÖ</span>
                  <span data-val="1">‚òÖ</span>
                </div>
                <div class="rateNum"><span id="rateNum">0</span>/5</div>
              </div>
            </div>

            <input type="hidden" id="rRate" value="0" />
          </div>

          <div class="obox">
            <label for="rText">üìù –í—ñ–¥–≥—É–∫: *</label>
            <textarea id="rText"></textarea>
            <div class="hint">–ë–µ–∑ —Ç–æ–∫—Å–∏–∫–∞ üôÇ</div>
          </div>

          <button id="rSend" class="btn primary">üì© –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤—ñ–¥–≥—É–∫</button>
          <div id="rStatus" class="status">–ó–∞–ø–æ–≤–Ω–∏ –ø–æ–ª—è.</div>
        </div>
      </div>

      <!-- –í–°–Ü –í–Ü–î–ì–£–ö–ò -->
      <div class="card">
        <div class="hd">
          <div class="hd__title">üóÇÔ∏è –í—Å—ñ –≤—ñ–¥–≥—É–∫–∏</div>

          <div class="muted small" style="display:flex;gap:10px;align-items:center;justify-content:flex-end;flex-wrap:wrap;">
            <span id="avgStars" style="font-size:18px;color:#e0182d;">‚Äî</span>
            <span><span id="avgRate">‚Äî</span>/5 ‚Ä¢ <span id="rCount">‚Äî</span></span>
          </div>
        </div>

        <div class="content">
          <div id="rList" class="cart"></div>
        </div>
      </div>

    </div>
  </div>

</main>

<script>
const REVIEWS_API = "https://odd-night-e9f6.d-f-12339.workers.dev/reviews";
const $ = (id) => document.getElementById(id);

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

function prefillFromQuery(){
  const qs = new URLSearchParams(location.search);
  const nick = qs.get("nick") || "";
  const disc = qs.get("disc") || "";
  if(nick) $("nick").value = nick;
  if(disc) $("disc").value = disc;
}

function formatWhen(v){
  if(!v) return "";
  const d = new Date(v);
  if(Number.isNaN(d.getTime())) return "";
  return d.toLocaleString("uk-UA", { dateStyle: "medium", timeStyle: "short" });
}

// ‚≠ê Average stars (rounded to nearest 0.5)
function toStars(avg){
  if(!Number.isFinite(avg) || avg <= 0) return "‚Äî";
  const half = Math.round(avg * 2) / 2;     // 0.5 step
  const full = Math.floor(half);
  const hasHalf = (half - full) === 0.5;
  const empty = 5 - full - (hasHalf ? 1 : 0);
  return "‚òÖ".repeat(full) + (hasHalf ? "‚Ø®" : "") + "‚òÜ".repeat(empty);
}

function renderReviewCard(x, idx, total){
  const nick = x.nick || "‚Äî";
  const disc = x.discord || "‚Äî";
  const text = x.text || "";
  const stars = Math.max(0, Math.min(5, Number(x.rate || 0)));
  const ratingHTML = stars
    ? `<div style="margin:6px 0;font-size:20px;color:#e0182d;">${"‚òÖ".repeat(stars)}${"‚òÜ".repeat(5 - stars)}</div>`
    : "";
  const when = formatWhen(x.created_at);
  const initials = (nick.trim().slice(0,1) || "‚òÖ").toUpperCase();

  const card = document.createElement("div");
  card.className = "cartItem";
  card.innerHTML = `
    <div style="display:flex;gap:12px;align-items:flex-start;">
      <div style="
        width:42px;height:42px;flex:0 0 42px;
        border-radius:14px;
        background: radial-gradient(20px 20px at 30% 30%, rgba(224,24,45,.35), rgba(255,255,255,.06));
        border:1px solid rgba(255,255,255,.10);
        display:flex;align-items:center;justify-content:center;
        font-weight:900;
        box-shadow:0 16px 45px rgba(0,0,0,.45);
      ">${escapeHtml(initials)}</div>

      <div style="min-width:0;flex:1;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div style="font-weight:900;font-size:1.02rem;line-height:1.2;">
            üí¨ ${escapeHtml(nick)}
          </div>
          <div class="muted small" style="
            white-space:nowrap;
            padding:6px 10px;
            border-radius:999px;
            border:1px solid rgba(255,255,255,.10);
            background: rgba(255,255,255,.04);
          ">#${total - idx}</div>
        </div>

        <div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
          <div class="mono" style="
            padding:6px 10px;border-radius:999px;
            border:1px solid rgba(224,24,45,.25);
            background: rgba(224,24,45,.10);
          ">${escapeHtml(disc)}</div>

          ${when ? `<div class="muted small" style="
            padding:6px 10px;border-radius:999px;
            border:1px solid rgba(255,255,255,.10);
            background: rgba(255,255,255,.04);
          ">üïí ${escapeHtml(when)}</div>` : ""}
        </div>

        ${ratingHTML}

        <div class="reviewText" style="
          margin-top:10px;
          padding:12px 12px;
          border-radius:16px;
          border:1px solid rgba(255,255,255,.10);
          background: rgba(255,255,255,.035);
          line-height:1.55;
          white-space:pre-wrap;
          word-break:break-word;
          width:100%;
          display:block;
          box-sizing:border-box;
          text-align:justify;
        ">${escapeHtml(text)}</div>
      </div>
    </div>
  `;
  return card;
}

async function loadReviews(){
  const wrap = $("rList");
  wrap.innerHTML = "";

  try{
    const url = REVIEWS_API + "?t=" + Date.now();
    const r = await fetch(url, { method:"GET", cache:"no-store" });

    const ct = r.headers.get("content-type") || "";
    const json = ct.includes("application/json") ? await r.json() : null;

    const data = Array.isArray(json?.reviews) ? json.reviews : (Array.isArray(json) ? json : []);
    $("rCount").textContent = data.length ? `${data.length}` : "0";

    const rates = data.map(x => Number(x.rate || 0)).filter(n => n > 0);
    const avg = rates.length ? (rates.reduce((a,b)=>a+b,0)/rates.length) : 0;

    $("avgRate").textContent = rates.length ? avg.toFixed(2) : "‚Äî";
    $("avgStars").textContent = toStars(avg);

    if(!data.length){
      wrap.innerHTML = `<div class="cartEmpty">–ü–æ–∫–∏ –≤—ñ–¥–≥—É–∫—ñ–≤ –Ω–µ–º–∞—î. –ë—É–¥—å –ø–µ—Ä—à–∏–º üôÇ</div>`;
      return;
    }

    // ‚úÖ –í—ñ–¥ –Ω–æ–≤–∏—Ö –¥–æ —Å—Ç–∞—Ä–∏—Ö
    data
      .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
      .forEach((x, idx) => wrap.appendChild(renderReviewCard(x, idx, data.length)));

  }catch(err){
    console.error("loadReviews error:", err);
    $("rCount").textContent = "0";
    $("avgRate").textContent = "‚Äî";
    $("avgStars").textContent = "‚Äî";
    wrap.innerHTML = `<div class="cartEmpty">‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—ñ–¥–≥—É–∫–∏ (–ø–µ—Ä–µ–≤—ñ—Ä –∫–æ–Ω—Å–æ–ª—å / –±–µ–∫–µ–Ω–¥).</div>`;
  }
}

async function sendReview(){
  const nick = $("nick").value.trim();
  const disc = $("disc").value.trim();
  const text = $("rText").value.trim();
  const rate = $("rRate").value;

  if(!nick || !disc || !text || Number(rate) < 1){
    $("rStatus").textContent = "‚ùå –ó–∞–ø–æ–≤–Ω–∏ Nick / Discord / –í—ñ–¥–≥—É–∫ —ñ –ø–æ—Å—Ç–∞–≤ –∑—ñ—Ä–æ—á–∫–∏.";
    return;
  }

  $("rSend").disabled = true;
  $("rStatus").textContent = "‚è≥ –í—ñ–¥–ø—Ä–∞–≤–ª—è—é...";

  const fd = new FormData();
  fd.append("nick", nick);
  fd.append("discord", disc);
  fd.append("text", text);
  fd.append("rate", rate);

  try{
    const res = await fetch(REVIEWS_API, { method:"POST", body: fd });
    const outText = await res.text().catch(()=> "");

    if(!res.ok){
      $("rStatus").textContent = `‚ùå –ü–æ–º–∏–ª–∫–∞: ${res.status} ${outText}`;
      $("rSend").disabled = false;
      return;
    }

    $("rStatus").textContent = "‚úÖ –î—è–∫—É—é! –í—ñ–¥–≥—É–∫ –¥–æ–¥–∞–Ω–æ.";
    $("rText").value = "";
    $("rRate").value = "0";
    stars.forEach(s => s.classList.remove("active"));
    const rn = document.getElementById("rateNum");
    if(rn) rn.textContent = "0";
    $("rSend").disabled = false;

    await loadReviews();
    setTimeout(loadReviews, 1200);
  }catch(err){
    console.error("sendReview error:", err);
    $("rStatus").textContent = "‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ (–ø–µ—Ä–µ–≤—ñ—Ä –∫–æ–Ω—Å–æ–ª—å).";
    $("rSend").disabled = false;
  }
}

// ‚≠ê Star rating logic
const stars = [...document.querySelectorAll("#rStars span")];
const rateInput = document.getElementById("rRate");
const rateNumEl = document.getElementById("rateNum");

function paint(val){
  stars.forEach(s => {
    const v = Number(s.dataset.val);
    s.classList.toggle("active", v <= val);
  });
}
function setRate(val){
  rateInput.value = String(val);
  if(rateNumEl) rateNumEl.textContent = String(val);
  paint(val);
}
function getRate(){
  return Number(rateInput.value || 0);
}

setRate(getRate());

stars.forEach(star => {
  const v = Number(star.dataset.val);
  star.addEventListener("mouseenter", () => paint(v));
  star.addEventListener("click", () => setRate(v));
});

document.getElementById("rStars").addEventListener("mouseleave", () => {
  paint(getRate());
});

$("rSend").addEventListener("click", sendReview);

function normalizeMention(s){
  const v = String(s || "").trim();
  if(!v) return "";
  const m = v.match(/^<@!?(\d+)>$/);
  if(m) return `<@${m[1]}>`;
  if(/^\d{6,}$/.test(v)) return `<@${v}>`;
  // allow @nick or nick
  return v.startsWith("@") ? v : v;
}

const LS_ORDER = "CASTRO_ORDER_V2";  // —è–∫ –Ω–∞ order.html
const LS_REV   = "CASTRO_REVIEWS_V1"; // –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è reviews

function readLS(key){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch{ return null; }
}

function saveReviewsLS(){
  try{
    localStorage.setItem(LS_REV, JSON.stringify({
      v: 1,
      nick: ($("nick")?.value || "").trim(),
      disc: ($("disc")?.value || "").trim()
    }));
  }catch{}
}

function prefillFromOrderLS(){
  const data = readLS(LS_ORDER);
  const nick = data?.form?.nick ? String(data.form.nick).trim() : "";
  const disc = data?.form?.disc ? String(data.form.disc).trim() : "";
  return { nick, disc };
}

function prefillFromReviewsLS(){
  const data = readLS(LS_REV);
  const nick = data?.nick ? String(data.nick).trim() : "";
  const disc = data?.disc ? String(data.disc).trim() : "";
  return { nick, disc };
}

function prefillFromProfileModal(){
  // —è–∫—â–æ profile.js –Ω–∞–ø–æ–≤–Ω—é—î pf-ic / pf-sid, –ø—ñ–¥—Ö–æ–ø–∏–º–æ —ñ —Ç—É—Ç
  const ic  = (document.getElementById("pf-ic")?.value || "").trim();
  const sid = (document.getElementById("pf-sid")?.value || "").trim();
  if(ic && sid) return `${ic} | ${sid}`;
  if(ic) return ic;
  return "";
}

function applyMention(){
  const discEl = $("disc");
  const mentionEl = $("discordMention");
  if(!discEl || !mentionEl) return;
  mentionEl.value = normalizeMention(discEl.value);
}

function prefillAutofill(){
  const nickEl = $("nick");
  const discEl = $("disc");
  if(!nickEl || !discEl) return;

  // 1) query params (–≤–∂–µ –ø–æ—Å—Ç–∞–≤–∏–ª–∏ —É prefillFromQuery)
  // 2) order localStorage (CASTRO_ORDER_V2)
  // 3) reviews localStorage
  // 4) profile modal (pf-ic/pf-sid)

  const orderLS = prefillFromOrderLS();
  const revLS = prefillFromReviewsLS();
  const profileNick = prefillFromProfileModal();

  if(!nickEl.value.trim()){
    nickEl.value = orderLS.nick || revLS.nick || profileNick || "";
  }

  if(!discEl.value.trim()){
    discEl.value = orderLS.disc || revLS.disc || "";
  }

  applyMention();
}

$("nick")?.addEventListener("input", () => {
  saveReviewsLS();
});

$("disc")?.addEventListener("input", () => {
  applyMention();
  saveReviewsLS();
});

// –ø—ñ—Å–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é ‚Äî —â–µ —Ä–∞–∑ –ø—ñ–¥—Ö–æ–ø–∏–º–æ Nick | Static ID
document.getElementById("pf-save")?.addEventListener("click", () => {
  setTimeout(prefillAutofill, 50);
});

prefillFromQuery();
prefillAutofill();
loadReviews();
</script>

<script src="auth.js"></script>
<script src="profile.js"></script>

</body>
</html>
