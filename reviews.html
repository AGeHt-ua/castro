<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–í—ñ–¥–≥—É–∫–∏ ‚Ä¢ CASTRO</title>
  <link rel="icon" type="image/png" href="assets/logo.png" />
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="order.css" />
</head>

<body class="order">
  <div class="sparks" aria-hidden="true"></div>

  <header class="pagehead">
    <div class="container pagehead__inner">
      <a class="back" href="index.html">‚Üê –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
      <div class="pagehead__title">
        <h1>üí¨ –í—ñ–¥–≥—É–∫–∏</h1>
        <p class="muted">–¢—É—Ç –≤–∏–¥–Ω–æ –≤—Å—ñ –≤—ñ–¥–≥—É–∫–∏. –ó–∞–ª–∏—à —Å–≤—ñ–π –ø—ñ—Å–ª—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è üôÇ</p>
      </div>
      <div class="pagehead__spacer" aria-hidden="true"></div>
    </div>
  </header>

  <main class="container">
    <div class="orderGrid">

      <!-- LEFT: form -->
      <div class="card">
        <div class="hd">
          <div class="hd__title">‚úçÔ∏è –ó–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫</div>
          <div class="muted small">* –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ</div>
        </div>

        <div class="content">
          <div class="row">
            <div>
              <label for="rNick">üíã –ù—ñ–∫–Ω–µ–π–º | Static ID: *</label>
              <input id="rNick" class="inp" placeholder="–ù–∞–ø—Ä: Dominic Castro | 12279" />
            </div>
            <div>
              <label for="rDisc">üßë‚Äçüíª Discord: *</label>
              <input id="rDisc" class="inp" placeholder="–ù–∞–ø—Ä: castro.ua" />
            </div>
          </div>

          <div class="obox">
            <label for="rText">üìù –í—ñ–¥–≥—É–∫: *</label>
            <textarea id="rText" placeholder="–ù–∞–ø–∏—à–∏ —á–µ—Å–Ω–æ: —â–æ —Å–ø–æ–¥–æ–±–∞–ª–æ—Å—å/—â–æ –ø–æ–∫—Ä–∞—â–∏—Ç–∏..."></textarea>
            <div class="hint">–ë–µ–∑ —Ç–æ–∫—Å–∏–∫–∞ ‚Äî –∞–±–æ –≤–∏–¥–∞–ª—é üôÇ</div>
          </div>

          <div class="obox">
            <label for="rPhoto">üì∑ –§–æ—Ç–æ (–Ω–µ–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ):</label>
            <input id="rPhoto" type="file" accept="image/*" />
            <div class="hint">jpg/png/webp, –±–∞–∂–∞–Ω–æ –¥–æ ~4MB</div>
          </div>

          <button id="rSend" class="btn primary">üì© –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤—ñ–¥–≥—É–∫</button>
          <div id="rStatus" class="status">–ó–∞–ø–æ–≤–Ω–∏ –ø–æ–ª—è —Ç–∞ –Ω–∞—Ç–∏—Å–Ω–∏ ‚Äú–ù–∞–¥—ñ—Å–ª–∞—Ç–∏‚Äù.</div>
        </div>
      </div>

      <!-- RIGHT: list -->
      <div class="card">
        <div class="hd">
          <div class="hd__title">üóÇÔ∏è –í—Å—ñ –≤—ñ–¥–≥—É–∫–∏</div>
          <div class="muted small" id="rCount">‚Äî</div>
        </div>

        <div class="content">
          <div id="rList" class="cart"></div>
        </div>
      </div>

    </div>
  </main>

<script>
const REVIEWS_API = "https://odd-night-e9f6.d-f-12339.workers.dev/reviews";

const $ = (id)=>document.getElementById(id);

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

async function loadReviews(){
  const r = await fetch(REVIEWS_API, { method:"GET" });
  const json = await r.json().catch(()=>({ ok:false, reviews: [] }));

  const data = Array.isArray(json) ? json : (json.reviews || []);

  $("rCount").textContent = data.length ? `${data.length}` : "0";

  const wrap = $("rList");
  wrap.innerHTML = "";

  if(!data.length){
    wrap.innerHTML = `<div class="cartEmpty">–ü–æ–∫–∏ –≤—ñ–¥–≥—É–∫—ñ–≤ –Ω–µ–º–∞—î. –ë—É–¥—å –ø–µ—Ä—à–∏–º üôÇ</div>`;
    return;
  }

  data.forEach(x=>{
    const card = document.createElement("div");
    card.className = "cartItem";
    const img = x.image_url
      ? `<div style="margin-top:8px">
           <img src="${escapeHtml(x.image_url)}" alt="photo" style="max-width:100%;border-radius:14px;border:1px solid rgba(255,255,255,.10)">
         </div>`
      : "";

    card.innerHTML = `
      <div class="cartL">
        <div class="cartTitle">üí¨ ${escapeHtml(x.nick)}</div>
        <div class="cartMeta">
          <div class="mono">@${escapeHtml(x.discord)}</div>
          <div style="margin-top:8px">${escapeHtml(x.text)}</div>
          ${img}
          <div class="muted small" style="margin-top:8px">${new Date(x.created_at).toLocaleString()}</div>
        </div>
      </div>
    `;
    wrap.appendChild(card);
  });
}

async function sendReview(){
  const nick = $("rNick").value.trim();
  const disc = $("rDisc").value.trim();
  const text = $("rText").value.trim();
  const file = $("rPhoto").files?.[0] || null;

  if(!nick || !disc || !text){
    $("rStatus").textContent = "‚ùå –ó–∞–ø–æ–≤–Ω–∏ Nick/Discord/–í—ñ–¥–≥—É–∫.";
    return;
  }

  $("rSend").disabled = true;
  $("rStatus").textContent = "‚è≥ –í—ñ–¥–ø—Ä–∞–≤–ª—è—é...";

  const fd = new FormData();
  fd.append("nick", nick);
  fd.append("discord", disc);
  fd.append("text", text);
  if(file) fd.append("photo", file, file.name);

  const res = await fetch(REVIEWS_API, { method:"POST", body: fd });
  const out = await res.text().catch(()=> "");

  if(!res.ok){
    $("rStatus").textContent = `‚ùå –ü–æ–º–∏–ª–∫–∞: ${res.status} ${out}`;
    $("rSend").disabled = false;
    return;
  }

  $("rStatus").textContent = "‚úÖ –î—è–∫—É—é! –í—ñ–¥–≥—É–∫ –¥–æ–¥–∞–Ω–æ.";
  $("rText").value = "";
  $("rPhoto").value = "";
  $("rSend").disabled = false;
  loadReviews();
}

$("rSend").addEventListener("click", sendReview);

prefillFromQuery();
loadReviews();
</script>
</body>
</html>
