<script>
const REVIEWS_API = "https://odd-night-e9f6.d-f-12339.workers.dev/reviews";
const $ = (id)=>document.getElementById(id);

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

function prefillFromQuery(){
  const qs = new URLSearchParams(location.search);
  const nick = qs.get("nick") || "";
  const disc = qs.get("disc") || "";
  if(nick) $("rNick").value = nick;
  if(disc) $("rDisc").value = disc;
}

function renderReviewCard(x, idx, total){
  const nick = x.nick || "‚Äî";
  const disc = x.discord || "‚Äî";
  const text = x.text || "";
  const when = x.created_at ? new Date(x.created_at).toLocaleString() : "";
  const initials = (nick.trim().slice(0,1) || "‚òÖ").toUpperCase();

  const img = x.image_url
    ? `<div style="margin-top:10px">
         <img src="${escapeHtml(x.image_url)}" alt="photo"
              style="max-width:100%;border-radius:16px;border:1px solid rgba(255,255,255,.10);box-shadow:0 18px 60px rgba(0,0,0,.45)">
       </div>`
    : "";

  const card = document.createElement("div");
  card.className = "cartItem";
  card.innerHTML = `
    <div style="display:flex;gap:12px;align-items:flex-start;">
      <div style="
        width:42px;height:42px;flex:0 0 42px;
        border-radius:14px;
        background: radial-gradient(20px 20px at 30% 30%, rgba(224,24,45,.35), rgba(255,255,255,.06));
        border:1px solid rgba(255,255,255,.10);
        display:flex;align-items:center;justify-content:center;
        font-weight:900;
        box-shadow:0 16px 45px rgba(0,0,0,.45);
      ">${escapeHtml(initials)}</div>

      <div style="min-width:0;flex:1;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div style="font-weight:900;font-size:1.02rem;line-height:1.2;">
            üí¨ ${escapeHtml(nick)}
          </div>
          <div class="muted small" style="
            white-space:nowrap;
            padding:6px 10px;
            border-radius:999px;
            border:1px solid rgba(255,255,255,.10);
            background: rgba(255,255,255,.04);
          ">#${total - idx}</div>
        </div>

        <div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
          <div class="mono" style="
            padding:6px 10px;border-radius:999px;
            border:1px solid rgba(224,24,45,.25);
            background: rgba(224,24,45,.10);
          ">@${escapeHtml(disc)}</div>

          <div class="muted small" style="
            padding:6px 10px;border-radius:999px;
            border:1px solid rgba(255,255,255,.10);
            background: rgba(255,255,255,.04);
          ">üïí ${escapeHtml(when)}</div>
        </div>

        <div style="
          margin-top:10px;
          padding:12px 12px;
          border-radius:16px;
          border:1px solid rgba(255,255,255,.10);
          background: rgba(255,255,255,.035);
          line-height:1.45;
          white-space:pre-wrap;
          word-break:break-word;
        ">${escapeHtml(text)}</div>

        ${img}
      </div>
    </div>
  `;
  return card;
}

async function loadReviews(){
  const wrap = $("rList");
  wrap.innerHTML = "";

  try{
    const url = REVIEWS_API + "?t=" + Date.now(); // –∞–Ω—Ç–∏-–∫–µ—à
    const r = await fetch(url, { method:"GET", cache:"no-store" });
    const json = await r.json();

    const data = Array.isArray(json?.reviews) ? json.reviews : (Array.isArray(json) ? json : []);
    $("rCount").textContent = data.length ? `${data.length}` : "0";

    if(!data.length){
      wrap.innerHTML = `<div class="cartEmpty">–ü–æ–∫–∏ –≤—ñ–¥–≥—É–∫—ñ–≤ –Ω–µ–º–∞—î. –ë—É–¥—å –ø–µ—Ä—à–∏–º üôÇ</div>`;
      return;
    }

    data.forEach((x, idx)=>{
      wrap.appendChild(renderReviewCard(x, idx, data.length));
    });
  }catch(err){
    console.error("loadReviews error:", err);
    $("rCount").textContent = "0";
    wrap.innerHTML = `<div class="cartEmpty">‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—ñ–¥–≥—É–∫–∏ (–ø–µ—Ä–µ–≤—ñ—Ä –∫–æ–Ω—Å–æ–ª—å / –±–µ–∫–µ–Ω–¥).</div>`;
  }
}

async function sendReview(){
  const nick = $("rNick").value.trim();
  const disc = $("rDisc").value.trim();
  const text = $("rText").value.trim();
  const file = $("rPhoto").files?.[0] || null;

  if(!nick || !disc || !text){
    $("rStatus").textContent = "‚ùå –ó–∞–ø–æ–≤–Ω–∏ Nick/Discord/–í—ñ–¥–≥—É–∫.";
    return;
  }

  $("rSend").disabled = true;
  $("rStatus").textContent = "‚è≥ –í—ñ–¥–ø—Ä–∞–≤–ª—è—é...";

  const fd = new FormData();
  fd.append("nick", nick);
  fd.append("discord", disc);
  fd.append("text", text);
  if(file) fd.append("photo", file, file.name);

  try{
    const res = await fetch(REVIEWS_API, { method:"POST", body: fd });
    const outText = await res.text().catch(()=> "");

    if(!res.ok){
      $("rStatus").textContent = `‚ùå –ü–æ–º–∏–ª–∫–∞: ${res.status} ${outText}`;
      $("rSend").disabled = false;
      return;
    }

    $("rStatus").textContent = "‚úÖ –î—è–∫—É—é! –í—ñ–¥–≥—É–∫ –¥–æ–¥–∞–Ω–æ.";
    $("rText").value = "";
    $("rPhoto").value = "";
    $("rSend").disabled = false;

    await loadReviews();
    setTimeout(loadReviews, 1200); // KV —ñ–Ω–∫–æ–ª–∏ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –∑ –∑–∞—Ç—Ä–∏–º–∫–æ—é
  }catch(err){
    console.error("sendReview error:", err);
    $("rStatus").textContent = "‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ (–ø–µ—Ä–µ–≤—ñ—Ä –∫–æ–Ω—Å–æ–ª—å).";
    $("rSend").disabled = false;
  }
}

$("rSend").addEventListener("click", sendReview);

prefillFromQuery();
loadReviews();
</script>
