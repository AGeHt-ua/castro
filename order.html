<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Family Castro ‚Ä¢ –û–ø—Ç–æ–≤–∏–π –ø—Ä–æ–¥–∞–∂ –∑–±—Ä–æ—ó</title>
  <meta name="description" content="–û—Ñ—ñ—Ü—ñ–π–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ —Ä–æ–¥–∏–Ω–∏ Family Castro." />

  <link rel="icon" type="image/png" href="assets/logo.png" />

  <!-- Open Graph / Discord / Telegram -->
  <meta property="og:title" content="Family Castro ‚Ä¢ –û–ø—Ç–æ–≤–∏–π –ø—Ä–æ–¥–∞–∂ –∑–±—Ä–æ—ó" />
  <meta property="og:description" content="–û–ø—Ç–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚Ä¢ –∫–æ—Ä–∑–∏–Ω–∞ ‚Ä¢ –∑–Ω–∏–∂–∫–∏ ‚Ä¢ –≤—ñ–¥–ø—Ä–∞–≤–∫–∞ –≤ Discord" />
  <meta property="og:image" content="https://family-castro.fun/assets/gun-castro.png" />
  <meta property="og:url" content="https://family-castro.fun/order.html" />
  <meta property="og:type" content="website" />

  <meta name="twitter:card" content="summary_large_image" />

  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="order.css" />

  <!-- –ù–µ–≤–µ–ª–∏–∫–∏–π CSS –¥–ª—è –∫–æ—Ä–∑–∏–Ω–∏ (—â–æ–± –Ω–µ —á—ñ–ø–∞—Ç–∏ —Ç–≤–æ—ó —Ñ–∞–π–ª–∏) -->
  <style>
    .cart{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin: 8px 0 12px;
    }
    .cartItem{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
    }
    .cartL{ min-width:0; }
    .cartTitle{ font-weight:900; line-height:1.1; }
    .cartMeta{ margin-top:6px; font-size:.92rem; opacity:.8; }
    .cartMeta .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .cartR{ display:flex; flex-direction:column; align-items:flex-end; gap:8px; }
    .cartPrice{ font-weight:900; white-space:nowrap; }
    .miniBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      font-weight: 900;
      cursor:pointer;
      transition:.2s;
      user-select:none;
    }
    .miniBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.12); }
    .miniBtn.danger{ border-color: rgba(224,24,45,.35); background: rgba(224,24,45,.10); }
    .cartTopRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 6px 0 10px;
    }
    .cartEmpty{
      padding: 12px;
      border-radius: 16px;
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      opacity:.85;
    }
    .rowBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 12px;
    }
  </style>
</head>

<body class="order">
  <div class="sparks" aria-hidden="true"></div>

  <header class="pagehead">
    <div class="container pagehead__inner">
      <a class="back" href="index.html">‚Üê –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>

      <div class="pagehead__title">
        <h1>
          <img class="heroLogo" src="assets/hero.gif" alt="CASTRO" loading="lazy">
          üî´ –û–ø—Ç–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑–±—Ä–æ—ó ‚Ä¢ <span class="brand-red">CASTRO</span>
        </h1>
        <p class="muted">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è ‚Üí –¢–æ–≤–∞—Ä ‚Üí –ö—ñ–ª—å–∫—ñ—Å—Ç—å ‚Üí –î–æ–¥–∞—Ç–∏ –≤ –∫–æ—à–∏–∫ ‚Üí –ß–µ–∫ ‚Üí –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –≤ Discord</p>

        <div class="orderHead__badgeRow">
          <span class="orderBadge">üß∫ –ö–æ—Ä–∑–∏–Ω–∞</span>
          <span class="orderBadge">üí∏ –ó–Ω–∏–∂–∫–∏</span>
          <span class="orderBadge">üì© Discord</span>
        </div>
      </div>

      <div class="pagehead__spacer" aria-hidden="true"></div>
    </div>
  </header>

  <main class="container">
    <div class="orderGrid">
      <!-- LEFT -->
      <div class="card">
        <div class="hd">
          <div class="hd__title">üìù –î–∞–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</div>
          <div class="muted small">* –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤—ñ –ø–æ–ª—è</div>
        </div>

        <div class="content">
          <div class="row">
            <div>
              <label for="nick">üíã –í–∞—à –ù—ñ–∫–Ω–µ–π–º | Static ID: *</label>
              <input id="nick" class="inp" placeholder="–ù–∞–ø—Ä: Dominic Castro | 12279" autocomplete="off" />
              <div class="hint">–Ø–∫ —É –≥—Ä—ñ: Nick | Static ID</div>
            </div>
            <div>
              <label for="disc">üßë‚Äçüíª –í–∞—à Discord: *</label>
              <input id="disc" class="inp" placeholder="–ù–∞–ø—Ä: castro.ua" autocomplete="off" />
              <div class="hint">–ë–µ–∑ @ ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω—ñ–∫</div>
            </div>
          </div>

          <div class="obox">
            <label>üìå –ö–∞—Ç–µ–≥–æ—Ä—ñ—è: *</label>
            <div id="cats" class="cats"></div>
            <div class="hint">–ü—ñ—Å–ª—è –≤–∏–±–æ—Ä—É –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –≤—ñ–¥–∫—Ä–∏—î—Ç—å—Å—è —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä—ñ–≤ (–∫–∞—Ä—Ç–∫–∞–º–∏).</div>
          </div>

          <div id="itemsWrap" class="obox" style="display:none">
            <label>üõí –û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä: *</label>
            <div id="items" class="items"></div>
            <div class="hint">–ö–ª—ñ–∫ –ø–æ –∫–∞—Ä—Ç—Ü—ñ ‚Äî –≤–∏–±—ñ—Ä —Ç–æ–≤–∞—Ä—É.</div>
          </div>

          <div id="qtyWrap" class="obox" style="display:none">
            <label>üì¶ –ö—ñ–ª—å–∫—ñ—Å—Ç—å (–∑—ñ –∑–Ω–∏–∂–∫–æ—é): *</label>
            <div id="qtyGrid" class="qty-grid"></div>
            <div id="qtyHint" class="hint"></div>

            <div style="height:10px"></div>
            <label for="qtyCustom">‚úçÔ∏è –°–≤–æ—è –∫—ñ–ª—å–∫—ñ—Å—Ç—å (–Ω–µ–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ):</label>
            <input id="qtyCustom" class="inp" inputmode="numeric" placeholder="–ù–∞–ø—Ä: 7 –∞–±–æ 1200" />
            <div class="hint">–ó–Ω–∏–∂–∫–∞ —Ä–∞—Ö—É—î—Ç—å—Å—è –ø–æ –Ω–∞–π–±–ª–∏–∂—á–æ–º—É –ø–æ—Ä–æ–≥—É —Ç–∞–±–ª–∏—Ü—ñ (‚â§ —Ç–≤–æ—è –∫—ñ–ª—å–∫—ñ—Å—Ç—å).</div>

            <!-- ‚úÖ –î–û–î–ê–¢–ò –í –ö–û–®–ò–ö -->
            <div class="rowBtns">
              <button id="addToCartBtn" class="btn primary" disabled>‚ûï –î–æ–¥–∞—Ç–∏ –≤ –∫–æ—à–∏–∫</button>
              <button id="resetPickBtn" class="btn" type="button">‚Ü©Ô∏è –°–∫–∏–Ω—É—Ç–∏ –≤–∏–±—ñ—Ä</button>
            </div>
            <div class="hint">–î–æ–¥–∞–≤–∞–π –∫—ñ–ª—å–∫–∞ –ø–æ–∑–∏—Ü—ñ–π —ñ –≤—ñ–¥–ø—Ä–∞–≤–ª—è–π –æ–¥–Ω—ñ—î—é –∑–∞—è–≤–∫–æ—é.</div>
          </div>

          <div id="armorWrap" class="obox" style="display:none">
            <label for="armorColor">üé® –ö–æ–ª—ñ—Ä –±—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç—É (—Ç–µ–∫—Å—Ç–æ–º): *</label>
            <input id="armorColor" class="inp" placeholder="–ù–∞–ø—Ä: —á–æ—Ä–Ω–∏–π / —Ç–µ–º–Ω–æ-—Å—ñ—Ä–∏–π / —á–µ—Ä–≤–æ–Ω–∏–π" />
            <div class="hint">–î–ª—è –±—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç—É –∫–æ–ª—ñ—Ä ‚Äî –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ.</div>
          </div>

          <div class="obox">
            <label for="delivery">üöö –°–ø–æ—Å—ñ–± –æ—Ç—Ä–∏–º–∞–Ω–Ω—è:</label>
            <select id="delivery">
              <option value="–°–∞–º–æ–≤–∏–≤—ñ–∑">–°–∞–º–æ–≤–∏–≤—ñ–∑</option>
              <option value="–î–æ—Å—Ç–∞–≤–∫–∞ (–∑—É—Å—Ç—Ä—ñ—á)">–î–æ—Å—Ç–∞–≤–∫–∞ (–∑—É—Å—Ç—Ä—ñ—á)</option>
              <option value="–ü–æ—à—Ç–∞">–ü–æ—à—Ç–∞</option>
            </select>
            <div class="hint">–Ø–∫—â–æ ‚Äú–ü–æ—à—Ç–∞‚Äù ‚Äî –Ω–∞–ø–∏—à–∏ –Ω–∏–∂—á–µ –∞–¥—Ä–µ—Å—É/–≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è.</div>

            <div style="height:10px"></div>
            <label for="note">üó∫Ô∏è –î–µ –∑–Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å / –¥–µ—Ç–∞–ª—ñ (–Ω–µ–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ):</label>
            <textarea id="note" placeholder="–ù–∞–ø—Ä: Los Santos, –±—ñ–ª—è –±–∞–Ω–∫—É / –∞–±–æ –ü–æ—à—Ç–∞ ‚Ññ..., —Ä–∞–π–æ–Ω..., —á–∞—Å..."></textarea>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="hd">
          <div class="hd__title">üßæ –ß–µ–∫ / –ö–æ—Ä–∑–∏–Ω–∞</div>
          <div class="muted small mono" id="orderId">order_id: ‚Äî</div>
        </div>

        <div class="content">
          <div class="receipt">
            <div class="cartTopRow">
              <div class="muted small">üß∫ –ü–æ–∑–∏—Ü—ñ—ó –≤ –∫–æ—à–∏–∫—É</div>
              <button id="clearCartBtn" class="miniBtn danger" type="button" title="–û—á–∏—Å—Ç–∏—Ç–∏ –∫–æ—à–∏–∫">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏</button>
            </div>

            <div id="cart" class="cart"></div>

            <div class="sep"></div>

            <div class="line"><span>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–∑–∏—Ü—ñ–π</span><span id="rLines">‚Äî</span></div>
            <div class="line"><span>–°—É–º–∞</span><span id="rSub">‚Äî</span></div>
            <div class="line"><span>–ó–Ω–∏–∂–∫–∞</span><span id="rDisc">‚Äî</span></div>
            <div class="sep"></div>
            <div class="total">
              <div class="line"><span>–î–æ —Å–ø–ª–∞—Ç–∏</span><span id="rTotal">‚Äî</span></div>
            </div>

            <button id="sendBtn" class="btn primary" disabled>üì© –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤ Discord</button>
            <div id="status" class="status">–ó–∞–ø–æ–≤–Ω–∏ –¥–∞–Ω—ñ –∑–ª—ñ–≤–∞, –¥–æ–¥–∞–π —Ç–æ–≤–∞—Ä–∏ –≤ –∫–æ—à–∏–∫ ‚Äî —ñ –≤—ñ–¥–ø—Ä–∞–≤–ª—è–π.</div>
          </div>
        </div>
      </div>

    </div>
  </main>

<script>
/* ==========================
   CONFIG
========================== */
const CONFIG = {
  ENDPOINT_URL: "https://odd-night-e9f6.d-f-12339.workers.dev",
  AUTH_HEADER_NAME: "X-Auth",
  AUTH_SECRET: "CASTRO_FORM_2026!9xQp",
  TIMEOUT_MS: 15000
};

/* ==========================
   DATA
========================== */
const CATALOG = {
  "–í–æ–≥–Ω–µ–ø–∞–ª—å–Ω–∞ –∑–±—Ä–æ—è": [
    { id:"pistol", name:"Pistol", price:8500, img:"guns/combat-pistol.png" },
    { id:"machine_pistol", name:"Machine Pistol", price:23000, img:"guns/machine-pistol.png" },
    { id:"pump_shotgun", name:"Pump Shotgun", price:25000, img:"guns/pump-shotgun.png" },
    { id:"combat_pdw", name:"Combat PDW", price:33500, img:"guns/combat-pdw.png" },
    { id:"assault_smg", name:"Assault SMG", price:35000, img:"guns/assault-smg.png" },
    { id:"bullpup_rifle", name:"Bullpup Rifle", price:37500, img:"guns/bullpup-rifle.png" },
    { id:"heavy_shotgun", name:"Heavy Shotgun", price:60000, img:"guns/heavy-shotgun.png" },
    { id:"mini_smg", name:"Mini SMG", price:32500, img:"guns/mini-smg.png" },
    { id:"special_carbine", name:"Special Carbine", price:60500, img:"guns/special-carbine.png" },
    { id:"special_carbine_mk2", name:"Special Carbine Mk II", price:65500, img:"guns/special-carbine-mk2.png" },
    { id:"carbine_rifle", name:"Carbine Rifle", price:30500, img:"guns/carbine-rifle.png" },
    { id:"pump_shotgun_mk2", name:"Pump Shotgun Mk II", price:27500, img:"guns/pump-shotgun-mk2.png" },
    { id:"heavy_revolver", name:"Heavy Revolver", price:35500, img:"guns/heavy-revolver.png" }
  ],
  "–•–æ–ª–æ–¥–Ω–∞ –∑–±—Ä–æ—è": [
    { id:"folding_knife", name:"–°–∫–ª–∞–¥–Ω–∏–π –Ω—ñ–∂", price:3000, img:"guns/Stilet.png" },
    { id:"hunting_knife", name:"–ú–∏—Å–ª–∏–≤—Å—å–∫–∏–π –Ω—ñ–∂", price:9500, img:"guns/knife.png" }
  ],
  "–ë–æ—î–ø—Ä–∏–ø–∞—Å–∏": [
    { id:"ammo_9mm", name:"9mm", price:55, img:"guns/9.png" },
    { id:"ammo_12mm", name:"12mm", price:55, img:"guns/12.png" },
    { id:"ammo_556", name:"5.56mm", price:60, img:"guns/5.png" },
    { id:"ammo_762", name:"7.62mm", price:62, img:"guns/7.png" }
  ],
  "–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç": [
    { id:"armor", name:"–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç", price:9000, img:"guns/armo.png" }
  ]
};

const DISCOUNTS_WEAPON = [
  { qty: 5,  pct: 0  },
  { qty:10,  pct: 2  },
  { qty:15,  pct: 3  },
  { qty:20,  pct: 4  },
  { qty:25,  pct: 5  },
  { qty:30,  pct: 10 },
  { qty:35,  pct: 15 },
  { qty:40,  pct: 17 },
  { qty:45,  pct: 19 },
  { qty:50,  pct: 20 }
];

const DISCOUNTS_AMMO = [
  { qty:100,  pct: 0  },
  { qty:250,  pct: 4  },
  { qty:500,  pct: 6  },
  { qty:1000, pct: 10 },
  { qty:1500, pct: 15 },
  { qty:2000, pct: 18 },
  { qty:2500, pct: 20 }
];

function money(n){
  const x = Math.round(Number(n) || 0);
  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

const $ = (id) => document.getElementById(id);

/* ==========================
   STATE
========================== */
const state = {
  order_id: `CASTRO-${Date.now().toString(36).toUpperCase()}-${Math.random().toString(36).slice(2,6).toUpperCase()}`,
  category: null,
  item: null,
  qty: null,
  discountPct: 0,
  armorColor: "",
  cart: [] // ‚úÖ –∫–æ—Ä–∑–∏–Ω–∞
};

/* ==========================
   UI INIT
========================== */
$("orderId").textContent = `order_id: ${state.order_id}`;

const catIcons = {
  "–í–æ–≥–Ω–µ–ø–∞–ª—å–Ω–∞ –∑–±—Ä–æ—è": "üî´",
  "–•–æ–ª–æ–¥–Ω–∞ –∑–±—Ä–æ—è": "üó°Ô∏è",
  "–ë–æ—î–ø—Ä–∏–ø–∞—Å–∏": "üì¶",
  "–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç": "üõ°Ô∏è"
};

function setStatus(msg){ $("status").textContent = msg; }

function getDiscountTableByCategory(cat){
  if(cat === "–ë–æ—î–ø—Ä–∏–ø–∞—Å–∏") return DISCOUNTS_AMMO;
  return DISCOUNTS_WEAPON;
}

function bestDiscountForQty(cat, qty){
  const table = getDiscountTableByCategory(cat);
  let best = table[0];
  for(const row of table){
    if(qty >= row.qty) best = row;
  }
  return best || { qty: 0, pct: 0 };
}

/* ==========================
   CATEGORY / ITEMS
========================== */
function renderCats(){
  const wrap = $("cats");
  wrap.innerHTML = "";
  Object.keys(CATALOG).forEach(cat=>{
    const btn = document.createElement("div");
    btn.className = "chip";
    btn.dataset.cat = cat;
    btn.innerHTML = `${catIcons[cat] || "üìå"} <span>${cat}</span>`;
    btn.onclick = () => selectCategory(cat);
    wrap.appendChild(btn);
  });
}

function selectCategory(cat){
  state.category = cat;
  state.item = null;
  state.qty = null;
  state.discountPct = 0;
  state.armorColor = "";
  $("armorColor").value = "";
  $("qtyCustom").value = "";

  [...$("cats").children].forEach(ch=>{
    ch.classList.toggle("active", ch.dataset.cat === cat);
  });

  $("itemsWrap").style.display = "block";
  $("qtyWrap").style.display = "none";
  $("armorWrap").style.display = (cat === "–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç") ? "block" : "none";

  renderItems();
  updateAll();
  setStatus(`–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ${cat}\n–¢–µ–ø–µ—Ä –æ–±–µ—Ä–∏ —Ç–æ–≤–∞—Ä.`);
}

function renderItems(){
  const items = CATALOG[state.category] || [];
  const wrap = $("items");
  wrap.innerHTML = "";

  items.forEach(it=>{
    const card = document.createElement("div");
    card.className = "item";
    card.dataset.item = it.id;

    card.innerHTML = `
      <div class="thumb">
        <img alt="${it.name}" src="${it.img}" loading="lazy" />
      </div>
      <div class="itm-body">
        <div class="itm-title">${it.name}</div>
        <div class="price">${money(it.price)}$ <small>/ 1 –æ–¥.</small></div>
      </div>
    `;

    const img = card.querySelector("img");
    img.addEventListener("error", ()=>{
      const thumb = card.querySelector(".thumb");
      thumb.innerHTML = `<div class="muted small">–ù–µ–º–∞—î –∫–∞—Ä—Ç–∏–Ω–∫–∏<br><span class="mono">–ø–µ—Ä–µ–≤—ñ—Ä —à–ª—è—Ö img</span></div>`;
    });

    card.onclick = () => selectItem(it.id);
    wrap.appendChild(card);
  });
}

function selectItem(itemId){
  const it = (CATALOG[state.category] || []).find(x=>x.id===itemId);
  if(!it) return;

  state.item = it;
  state.qty = null;
  state.discountPct = 0;
  $("qtyCustom").value = "";

  [...$("items").children].forEach(c=>{
    c.classList.toggle("active", c.dataset.item === itemId);
  });

  $("qtyWrap").style.display = "block";
  renderQtyPresets();
  updateAll();
  setStatus(`–¢–æ–≤–∞—Ä: ${it.name}\n–û–±–µ—Ä–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —ñ –¥–æ–¥–∞–π —É –∫–æ—à–∏–∫.`);
}

/* ==========================
   QTY
========================== */
function renderQtyPresets(){
  const wrap = $("qtyGrid");
  wrap.innerHTML = "";
  const table = getDiscountTableByCategory(state.category);

  $("qtyHint").textContent = (state.category === "–ë–æ—î–ø—Ä–∏–ø–∞—Å–∏")
    ? "–ó–Ω–∏–∂–∫–∞ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –±–æ—î–ø—Ä–∏–ø–∞—Å—ñ–≤."
    : "–ó–Ω–∏–∂–∫–∞ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –æ–¥–∏–Ω–∏—Ü—å.";

  table.forEach(row=>{
    const b = document.createElement("div");
    b.className = "qty";
    b.dataset.qty = String(row.qty);

    const d = row.pct ? `-${row.pct}%` : "–±–µ–∑ –∑–Ω–∏–∂–∫–∏";
    b.innerHTML = `<div>${row.qty}</div><span class="d">${d}</span>`;
    b.onclick = () => {
      $("qtyCustom").value = "";
      selectQty(row.qty, row.pct);
    };
    wrap.appendChild(b);
  });
}

function selectQty(qty, pct){
  state.qty = qty;
  state.discountPct = pct;

  [...$("qtyGrid").children].forEach(c=>{
    c.classList.toggle("active", Number(c.dataset.qty) === Number(qty));
  });

  updateAll();
  setStatus(`‚úÖ –ì–æ—Ç–æ–≤–æ –¥–æ –¥–æ–¥–∞–≤–∞–Ω–Ω—è\n${state.category} ‚Ä¢ ${state.item?.name}\n–ö—ñ–ª—å–∫—ñ—Å—Ç—å: ${state.qty}\n–ó–Ω–∏–∂–∫–∞: -${state.discountPct}%`);
}

function applyCustomQty(v){
  const n = Math.max(0, Math.floor(Number(String(v).replace(/[^\d]/g,"")) || 0));
  if(!n) return;

  const best = bestDiscountForQty(state.category, n);
  state.qty = n;
  state.discountPct = best.pct || 0;

  [...$("qtyGrid").children].forEach(c=>{
    c.classList.toggle("active", Number(c.dataset.qty) === Number(best.qty));
  });

  updateAll();
  setStatus(`‚úÖ –°–≤–æ—è –∫—ñ–ª—å–∫—ñ—Å—Ç—å\n${state.category} ‚Ä¢ ${state.item?.name}\n–ö—ñ–ª—å–∫—ñ—Å—Ç—å: ${state.qty}\n–ó–Ω–∏–∂–∫–∞: -${state.discountPct}% (–ø–æ—Ä—ñ–≥ ${best.qty})`);
}

/* ==========================
   CART
========================== */
function lineCalc(cat, unitPrice, qty, discountPct){
  const subtotal = unitPrice * qty;
  const disc = Math.round(subtotal * (discountPct || 0) / 100);
  const total = subtotal - disc;
  return { subtotal, disc, total };
}

function canAddLine(){
  if(!state.category || !state.item || !state.qty) return false;
  if(state.category === "–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç"){
    const c = $("armorColor").value.trim();
    if(!c) return false;
    state.armorColor = c;
  }
  return true;
}

function addToCart(){
  if(!canAddLine()){
    setStatus("‚ùå –í–∏–±–µ—Ä–∏ —Ç–æ–≤–∞—Ä/–∫—ñ–ª—å–∫—ñ—Å—Ç—å. –î–ª—è –±—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç—É ‚Äî –∑–∞–ø–æ–≤–Ω–∏ –∫–æ–ª—ñ—Ä.");
    return;
  }

  const cat = state.category;
  const it = state.item;
  const qty = state.qty;
  const pct = state.discountPct || 0;

  // –Ø–∫—â–æ –≤–∂–µ —î —Ç–∞–∫–∏–π —Ç–æ–≤–∞—Ä + —Ç–∞–∫–∞ –∂ "–æ–ø—Ü—ñ—è" (–¥–ª—è –±—Ä–æ–Ω—ñ ‚Äî –∫–æ–ª—ñ—Ä), –æ–±‚Äô—î–¥–Ω–∞—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
  const armorColor = (cat === "–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç") ? $("armorColor").value.trim() : null;

  const keyMatch = (x) =>
    x.item.id === it.id &&
    x.category === cat &&
    (cat !== "–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç" ? true : (x.armor_color || "").toLowerCase() === (armorColor || "").toLowerCase());

  const existing = state.cart.find(keyMatch);

  if(existing){
    existing.qty += qty;

    // –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ –∑–Ω–∏–∂–∫—É –¥–ª—è —Ü—ñ—î—ó –ø–æ–∑–∏—Ü—ñ—ó –ø–æ –Ω–æ–≤—ñ–π –∫—ñ–ª—å–∫–æ—Å—Ç—ñ
    const best = bestDiscountForQty(existing.category, existing.qty);
    existing.discount_pct = best.pct || 0;

    const sums = lineCalc(existing.category, existing.item.unit_price, existing.qty, existing.discount_pct);
    existing.subtotal = sums.subtotal;
    existing.discount_amount = sums.disc;
    existing.total = sums.total;
  }else{
    const sums = lineCalc(cat, it.price, qty, pct);
    state.cart.push({
      line_id: `L-${Date.now().toString(36).toUpperCase()}-${Math.random().toString(36).slice(2,6).toUpperCase()}`,
      category: cat,
      item: { id: it.id, name: it.name, unit_price: it.price },
      qty,
      discount_pct: pct,
      subtotal: sums.subtotal,
      discount_amount: sums.disc,
      total: sums.total,
      armor_color: (cat === "–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç") ? armorColor : null
    });
  }

  // –°–∫–∏–¥–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å (—â–æ–± –±—É–ª–æ –∑—Ä—É—á–Ω–æ –¥–æ–¥–∞–≤–∞—Ç–∏ —ñ–Ω—à—ñ –ø–æ–∑–∏—Ü—ñ—ó)
  state.qty = null;
  state.discountPct = 0;
  $("qtyCustom").value = "";
  [...$("qtyGrid").children].forEach(c=>c.classList.remove("active"));

  updateAll();
  setStatus("‚úÖ –î–æ–¥–∞–Ω–æ –≤ –∫–æ—à–∏–∫! –ú–æ–∂–µ—à –¥–æ–¥–∞—Ç–∏ —â–µ –ø–æ–∑–∏—Ü—ñ—ó –∞–±–æ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è.");
}

function removeLine(lineId){
  state.cart = state.cart.filter(x => x.line_id !== lineId);
  updateAll();
  setStatus("üóëÔ∏è –ü–æ–∑–∏—Ü—ñ—é –≤–∏–¥–∞–ª–µ–Ω–æ –∑ –∫–æ—à–∏–∫–∞.");
}

function clearCart(){
  state.cart = [];
  updateAll();
  setStatus("üß∫ –ö–æ—à–∏–∫ –æ—á–∏—â–µ–Ω–æ.");
}

function renderCart(){
  const wrap = $("cart");
  wrap.innerHTML = "";

  if(!state.cart.length){
    wrap.innerHTML = `<div class="cartEmpty">–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π. –î–æ–¥–∞–π —Ç–æ–≤–∞—Ä–∏ –∑–ª—ñ–≤–∞.</div>`;
    return;
  }

  state.cart.forEach(line=>{
    const div = document.createElement("div");
    div.className = "cartItem";

    const dtxt = line.discount_pct ? `-${line.discount_pct}% (${money(line.discount_amount)}$)` : `0% (0$)`;
    const armor = (line.category === "–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç" && line.armor_color) ? ` ‚Ä¢ üé® ${line.armor_color}` : "";

    div.innerHTML = `
      <div class="cartL">
        <div class="cartTitle">${catIcons[line.category] || "üìå"} ${line.item.name}</div>
        <div class="cartMeta">
          <div>${line.category}${armor}</div>
          <div><span class="mono">${money(line.item.unit_price)}$</span> √ó <span class="mono">${line.qty}</span> ‚Ä¢ –∑–Ω–∏–∂–∫–∞: <span class="mono">${dtxt}</span></div>
        </div>
      </div>

      <div class="cartR">
        <div class="cartPrice">${money(line.total)}$</div>
        <div class="miniBtn danger" role="button" tabindex="0">üóëÔ∏è</div>
      </div>
    `;

    div.querySelector(".miniBtn.danger").onclick = () => removeLine(line.line_id);
    wrap.appendChild(div);
  });
}

function cartTotals(){
  const lines = state.cart.length;
  const subtotal = state.cart.reduce((s,x)=>s+(Number(x.subtotal)||0),0);
  const discount = state.cart.reduce((s,x)=>s+(Number(x.discount_amount)||0),0);
  const total = state.cart.reduce((s,x)=>s+(Number(x.total)||0),0);
  return { lines, subtotal, discount, total };
}

/* ==========================
   VALIDATION + RECEIPT
========================== */
function isValidToSend(){
  const nick = $("nick").value.trim();
  const disc = $("disc").value.trim();
  if(!nick || !disc) return false;
  if(!state.cart.length) return false;
  return true;
}

function updateReceipt(){
  const t = cartTotals();
  $("rLines").textContent = t.lines ? `${t.lines}` : "‚Äî";
  $("rSub").textContent = t.lines ? `${money(t.subtotal)}$` : "‚Äî";
  $("rDisc").textContent = t.lines ? `${money(t.discount)}$` : "‚Äî";
  $("rTotal").textContent = t.lines ? `${money(t.total)}$` : "‚Äî";

  $("sendBtn").disabled = !isValidToSend();
}

function updateAddBtn(){
  $("addToCartBtn").disabled = !canAddLine();
}

/* ==========================
   SEND
========================== */
let sending = false;

async function sendOrder(){
  if(sending) return;
  if(!isValidToSend()){
    setStatus("‚ùå –ó–∞–ø–æ–≤–Ω–∏ Nick/Discord —ñ –¥–æ–¥–∞–π —Ö–æ—á–∞ –± 1 –ø–æ–∑–∏—Ü—ñ—é –≤ –∫–æ—à–∏–∫.");
    return;
  }

  sending = true;
  $("sendBtn").disabled = true;

  const nick = $("nick").value.trim();
  const disc = $("disc").value.trim();
  const delivery = $("delivery").value;
  const note = $("note").value.trim();

  const totals = cartTotals();

  const payload = {
    order_id: state.order_id,
    created_at: new Date().toISOString(),
    buyer: { nick_static: nick, discord: disc },
    items: state.cart.map(x=>({
      line_id: x.line_id,
      category: x.category,
      item: x.item,
      qty: x.qty,
      discount_pct: x.discount_pct,
      subtotal: x.subtotal,
      discount_amount: x.discount_amount,
      total: x.total,
      armor_color: x.armor_color || null
    })),
    totals: {
      lines: totals.lines,
      subtotal: totals.subtotal,
      discount_amount: totals.discount,
      total: totals.total
    },
    delivery,
    note
  };

  setStatus("‚è≥ –í—ñ–¥–ø—Ä–∞–≤–ª—è—é –≤ Discord...");

  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), CONFIG.TIMEOUT_MS);

  try{
    const res = await fetch(CONFIG.ENDPOINT_URL, {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        [CONFIG.AUTH_HEADER_NAME]: CONFIG.AUTH_SECRET
      },
      body: JSON.stringify(payload),
      signal: controller.signal
    });

    clearTimeout(t);

    const text = await res.text().catch(()=> "");
    if(!res.ok){
      setStatus(`‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞: ${res.status}\n${text || ""}`.trim());
      sending = false;
      updateReceipt();
      return;
    }

    setStatus(`‚úÖ –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ!\norder_id: ${state.order_id}\n–ü–æ–∑–∏—Ü—ñ–π: ${totals.lines}\n–°—É–º–∞ –¥–æ —Å–ø–ª–∞—Ç–∏: ${money(totals.total)}$\n\n–í Discord –º–∞—î –∑‚Äô—è–≤–∏—Ç–∏—Å—å –∑–∞—è–≤–∫–∞ (–±–æ—Ç –¥–æ–¥–∞—Å—Ç—å –∫–Ω–æ–ø–∫–∏ ‚úÖ/‚ùå).`);
  }catch(err){
    clearTimeout(t);
    setStatus(`‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏.\n${String(err)}`);
    sending = false;
    updateReceipt();
    return;
  }

  // –∑–∞–ª–∏—à–∞—î–º–æ –∫–Ω–æ–ø–∫—É –≤–∏–º–∫–Ω–µ–Ω–æ—é, —â–æ–± –Ω–µ –¥—É–±–ª—é–≤–∞–ª–∏
}

/* ==========================
   RESET PICK
========================== */
function resetPick(){
  state.item = null;
  state.qty = null;
  state.discountPct = 0;
  $("qtyCustom").value = "";
  $("armorColor").value = "";
  $("itemsWrap").style.display = (state.category ? "block" : "none");
  $("qtyWrap").style.display = "none";
  [...$("items").children].forEach(c=>c.classList.remove("active"));
  setStatus("‚Ü©Ô∏è –í–∏–±—ñ—Ä —Å–∫–∏–Ω—É—Ç–æ. –û–±–µ—Ä–∏ —Ç–æ–≤–∞—Ä –∑–∞–Ω–æ–≤–æ.");
  updateAll();
}

/* ==========================
   EVENTS
========================== */
$("nick").addEventListener("input", ()=>{ updateReceipt(); });
$("disc").addEventListener("input", ()=>{ updateReceipt(); });

$("armorColor").addEventListener("input", ()=>{ updateAddBtn(); });

$("qtyCustom").addEventListener("input", (e)=>{
  const v = e.target.value;
  if(!v) return;
  if(!state.category || !state.item) return;
  applyCustomQty(v);
  updateAddBtn();
});

$("addToCartBtn").addEventListener("click", addToCart);
$("resetPickBtn").addEventListener("click", resetPick);

$("clearCartBtn").addEventListener("click", clearCart);
$("sendBtn").addEventListener("click", sendOrder);

/* ==========================
   UPDATE ALL
========================== */
function updateAll(){
  renderCart();
  updateReceipt();
  updateAddBtn();
}

/* INIT */
renderCats();
updateAll();
</script>

</body>
</html>
