<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Family Castro ‚Ä¢ –û–ø—Ç–æ–≤–∏–π –ø—Ä–æ–¥–∞–∂ –∑–±—Ä–æ—ó</title>
  <meta name="description" content="–û—Ñ—ñ—Ü—ñ–π–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ —Ä–æ–¥–∏–Ω–∏ Family Castro." />

  <link rel="icon" type="image/png" href="assets/logo.png" />

  <meta property="og:title" content="Family Castro ‚Ä¢ –û–ø—Ç–æ–≤–∏–π –ø—Ä–æ–¥–∞–∂ –∑–±—Ä–æ—ó" />
  <meta property="og:description" content="–û–ø—Ç–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚Ä¢ –∫–æ—Ä–∑–∏–Ω–∞ ‚Ä¢ –∑–Ω–∏–∂–∫–∏ ‚Ä¢ –≤—ñ–¥–ø—Ä–∞–≤–∫–∞ –≤ Discord" />
  <meta property="og:image" content="https://family-castro.fun/assets/gun-castro.png" />
  <meta property="og:url" content="https://family-castro.fun/order.html" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />

  <link rel="stylesheet" href="auth.css" />
  <link rel="stylesheet" href="order.css" />

<style>
  /* CASTRO: Order ‚Äî hide Nick/StaticID + Discord fields (autofilled by profile.js) */
  body.order .identityRow{ display:none !important; }
</style>


<style>
  /* CASTRO: Auth/Profile hint */
  .authHint{
    margin: 14px 0;
    padding: 14px;
    border-radius: 14px;
    background: rgba(0,0,0,.45);
    border: 1px solid rgba(255,255,255,.12);
    backdrop-filter: blur(10px);
  }
  .authHint__title{
    font-weight: 900;
    margin-bottom: 6px;
  }
  .authHint__text{
    color: rgba(255,255,255,.8);
    font-size: 13px;
    line-height: 1.4;
  }
  .authHint__actions{
    margin-top: 10px;
    display:flex;
    gap:10px;
    flex-wrap: wrap;
  }
  .authHint__btn{
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,70,70,.35);
    background: rgba(255,70,70,.14);
    color:#fff;
    font-weight: 800;
    cursor:pointer;
  }
  .authHint__btn--ghost{
    border-color: rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
  }
</style>

</head>

<body class="order">

<!-- VIDEO LOADER (CASTRO) -->
<div class="vload" id="vload" aria-hidden="false">
  <div class="vload__bg"></div> 

  <div class="vload__center">
    <img class="vload__logo" src="assets/hero.gif" alt="CASTRO">
    <div class="vload__ring" aria-hidden="true"></div>
    <div class="vload__text">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>
  </div>

  <div class="vload__scan" aria-hidden="true"></div>
  <div class="vload__grain" aria-hidden="true"></div>
</div>
  
  <!-- VIDEO BACKGROUND -->
<div class="video-bg">
  <video autoplay muted loop playsinline id="bgVideo">
    <source src="assets/order-bg.mp4" type="video/mp4">
  </video>
  <div class="video-overlay"></div>
</div>

  <!-- üîê Discord Auth (top-right) ‚Äî –í–ê–ñ–õ–ò–í–û: –¢–Ü–õ–¨–ö–ò –í BODY -->
  <div id="auth-box" class="auth">
    <button id="auth-login" class="auth__btn" type="button">
      <img class="auth__discord" src="assets/discord.svg" alt="">
      –£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Discord
    </button>

    <div id="auth-user" class="auth__user hidden">
      <img id="auth-avatar" class="auth__avatar" alt="">
      <span id="auth-name" class="auth__name"></span>
      <button id="auth-logout" class="auth__logout" type="button" title="–í–∏–π—Ç–∏">‚éã</button>
    </div>
  </div>

  <!-- üîê AUTH / PROFILE HINT -->
  <div class="authHint" id="authHint" aria-live="polite">
    <div class="authHint__title">üîê –î–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ—ñ–ª—å</div>
    <div class="authHint__text" id="authHintText">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó‚Ä¶</div>
    <div class="authHint__actions" id="authHintActions"></div>
  </div>


 <header class="topbar" aria-label="–ù–∞–≤—ñ–≥–∞—Ü—ñ—è">
  <a class="back back--pill" href="index.html">‚Üê –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>

  <div class="topbar__title">
    üî´ –û–ø—Ç–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑–±—Ä–æ—ó
    <span class="castro castro--logo">
      CASTRO
      <img src="assets/hero.gif" alt="CASTRO" class="castroLogo">
    </span>
  </div>

  <div class="topbar__meta">
    <span class="orderBadge">üí∏ –ó–Ω–∏–∂–∫–∏</span>
    <span class="chip">üõ°Ô∏è –ó–∞—Ö–∏—Å—Ç —Ç–æ–∫–µ–Ω–æ–º</span>
    <a class="chip" href="reviews.html">üí¨ –í—ñ–¥–≥—É–∫–∏ <span id="reviewsBadge" class="badgeCount">0</span></a>
  </div>
</header>

  <main class="container">
    <div class="orderGrid">

      <!-- LEFT -->
      <div class="card">
        <div class="hd">
          <div class="hd__title">üìù –î–∞–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</div>
          <div class="muted small">* –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤—ñ –ø–æ–ª—è</div>
        </div>

        <div class="content">

          <div class="row identityRow">
            <div>
              <label for="nick">üíã –í–∞—à –ù—ñ–∫–Ω–µ–π–º | Static ID: *</label>
              <input id="nick" class="inp" placeholder="–ù–∞–ø—Ä: Dominic Castro | 12279" autocomplete="off" name="nicknameId" />
              <div class="hint">–Ø–∫ —É –≥—Ä—ñ: Nick | Static ID</div>
            </div>

            <div>
              <label for="disc">üßë‚Äçüíª –í–∞—à Discord: *</label>
              <input id="disc" class="inp" placeholder="–ù–∞–ø—Ä: castro.ua" autocomplete="off" name="discord" />
              <input type="hidden" name="discordMention" id="discordMention" />
              <div class="hint">–ë–µ–∑ @ ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω—ñ–∫</div>
            </div>
          </div>

          <div class="obox">
            <label>üìå –ö–∞—Ç–µ–≥–æ—Ä—ñ—è: *</label>
            <div id="cats" class="cats"></div>
            <div class="hint">–ü—ñ—Å–ª—è –≤–∏–±–æ—Ä—É –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –≤—ñ–¥–∫—Ä–∏—î—Ç—å—Å—è —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä—ñ–≤ (–∫–∞—Ä—Ç–∫–∞–º–∏).</div>
          </div>

          <div id="itemsWrap" class="obox" style="display:none">
            <label>üõí –û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä: *</label>
            <div id="items" class="items"></div>
            <div class="hint">–ö–ª—ñ–∫ –ø–æ –∫–∞—Ä—Ç—Ü—ñ ‚Äî –≤–∏–±—ñ—Ä —Ç–æ–≤–∞—Ä—É.</div>
          </div>

          <div id="qtyWrap" class="obox" style="display:none">
            <label>üì¶ –ö—ñ–ª—å–∫—ñ—Å—Ç—å (–∑—ñ –∑–Ω–∏–∂–∫–æ—é): *</label>
            <div id="qtyGrid" class="qty-grid"></div>
            <div id="qtyHint" class="hint"></div>

            <div style="height:10px"></div>
            <label for="qtyCustom">‚úçÔ∏è –°–≤–æ—è –∫—ñ–ª—å–∫—ñ—Å—Ç—å (–Ω–µ–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ):</label>
            <input id="qtyCustom" class="inp" inputmode="numeric" placeholder="–ù–∞–ø—Ä: 7 –∞–±–æ 1200" />
            <div class="hint">–ó–Ω–∏–∂–∫–∞ —Ä–∞—Ö—É—î—Ç—å—Å—è –ø–æ –Ω–∞–π–±–ª–∏–∂—á–æ–º—É –ø–æ—Ä–æ–≥—É —Ç–∞–±–ª–∏—Ü—ñ (‚â§ —Ç–≤–æ—è –∫—ñ–ª—å–∫—ñ—Å—Ç—å).</div>

            <div class="rowBtns">
              <button id="addToCartBtn" class="btn primary" disabled type="button">‚ûï –î–æ–¥–∞—Ç–∏ –≤ –∫–æ—à–∏–∫</button>
              <button id="resetPickBtn" class="btn" type="button">‚Ü©Ô∏è –°–∫–∏–Ω—É—Ç–∏ –≤–∏–±—ñ—Ä</button>
            </div>
          </div>

          <div id="armorWrap" class="obox" style="display:none">
            <label for="armorColor">üé® –ö–æ–ª—ñ—Ä –±—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç—É (—Ç–µ–∫—Å—Ç–æ–º): *</label>
            <input id="armorColor" class="inp" placeholder="–ù–∞–ø—Ä: —á–æ—Ä–Ω–∏–π / —Ç–µ–º–Ω–æ-—Å—ñ—Ä–∏–π / —á–µ—Ä–≤–æ–Ω–∏–π" />
            <div class="hint">–î–ª—è –±—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç—É –∫–æ–ª—ñ—Ä ‚Äî –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ.</div>
          </div>

          <div class="obox">
            <label for="delivery">üöö –°–ø–æ—Å—ñ–± –æ—Ç—Ä–∏–º–∞–Ω–Ω—è:</label>
            <select id="delivery">
              <option value="–°–∞–º–æ–≤–∏–≤—ñ–∑">–°–∞–º–æ–≤–∏–≤—ñ–∑</option>
              <option value="–î–æ—Å—Ç–∞–≤–∫–∞ (–∑—É—Å—Ç—Ä—ñ—á)">–î–æ—Å—Ç–∞–≤–∫–∞ (–∑—É—Å—Ç—Ä—ñ—á)</option>
              <option value="–ü–æ—à—Ç–∞">–ü–æ—à—Ç–∞</option>
            </select>
            <div class="hint">–Ø–∫—â–æ ‚Äú–ü–æ—à—Ç–∞‚Äù ‚Äî –Ω–∞–ø–∏—à–∏ –Ω–∏–∂—á–µ –∞–¥—Ä–µ—Å—É/–≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è.</div>

            <div style="height:10px"></div>
            <label for="note">üó∫Ô∏è –î–µ –∑–Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å / –¥–µ—Ç–∞–ª—ñ (–Ω–µ–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ):</label>
            <textarea id="note" placeholder="–ù–∞–ø—Ä: Los Santos, –±—ñ–ª—è –±–∞–Ω–∫—É / –∞–±–æ –ü–æ—à—Ç–∞ ‚Ññ..., —Ä–∞–π–æ–Ω..., —á–∞—Å..."></textarea>
          </div>
          
          <div class="footer">Family CASTRO ‚Ä¢ Ukraine GTA 5 RP</div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="hd">
          <div class="hd__title">üì¶ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚Ññ:</div>
          <div class="muted small mono" id="orderId">‚Äî</div>
        </div>

        <div class="content">
          <div class="receipt">
            <div class="cartTopRow">
              <div class="muted small">üß∫ –ü–æ–∑–∏—Ü—ñ—ó –≤ –∫–æ—à–∏–∫—É</div>
              <button id="clearCartBtn" class="miniBtn danger" type="button" title="–û—á–∏—Å—Ç–∏—Ç–∏ –∫–æ—à–∏–∫">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏</button>
            </div>

            <div id="cart" class="cart"></div>

            <div class="sep"></div>

            <div class="line"><span>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–∑–∏—Ü—ñ–π</span><span id="rLines">‚Äî</span></div>
            <div class="line"><span>–°—É–º–∞</span><span id="rSub">‚Äî</span></div>
            <div class="line"><span>–ó–Ω–∏–∂–∫–∞</span><span id="rDisc">‚Äî</span></div>

            <div class="sep"></div>

            <div class="total">
              <div class="line"><span>–î–æ —Å–ø–ª–∞—Ç–∏</span><span id="rTotal">‚Äî</span></div>
            </div>

            <button id="sendBtn" class="btn primary" disabled type="button">üì© –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤ Discord</button>
            <div id="status" class="status">–ó–∞–ø–æ–≤–Ω–∏ –¥–∞–Ω—ñ –∑–ª—ñ–≤–∞, –¥–æ–¥–∞–π —Ç–æ–≤–∞—Ä–∏ –≤ –∫–æ—à–∏–∫ ‚Äî —ñ –≤—ñ–¥–ø—Ä–∞–≤–ª—è–π.</div>
            <div class="avgAfterStatus">
              <span id="avgRating" class="ratingBlock">‚≠ê –°–µ—Ä–µ–¥–Ω—ñ–π —Ä–µ–π—Ç–∏–Ω–≥: ‚Äî / 5</span>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

<script>
/* ==========================
   CONFIG
========================== */
const CONFIG = {
  ENDPOINT_URL: "https://api.family-castro.fun",
  TIMEOUT_MS: 15000,

  // ‚úÖ X-Token (—Å—Ç–∞–±—ñ–ª—å–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –¥–ª—è API)
  // 1) –∞–±–æ –≤–ø–∏—à–∏ —Ç—É—Ç –≤—Ä—É—á–Ω—É
  // 2) –∞–±–æ –∑–∞–¥–∞–π –≤ LocalStorage –∫–ª—é—á CASTRO_XTOKEN (—Ä–µ–∫–æ–º–µ–Ω–¥—É—é)
  X_TOKEN: localStorage.getItem("CASTRO_XTOKEN") || "PASTE_YOUR_X_TOKEN_SECRET_HERE"
};

const ASSET_BASE = "https://family-castro.fun/";
const LS_KEY = "CASTRO_ORDER_V2";

/* ==========================
   DATA
========================== */
const CATALOG = {
  "–í–æ–≥–Ω–µ–ø–∞–ª—å–Ω–∞ –∑–±—Ä–æ—è": [
    { id:"pistol", name:"Pistol", price:9000, img:"guns/combat-pistol.png" },
    { id:"machine_pistol", name:"Machine Pistol", price:24000, img:"guns/machine-pistol.png" },
    { id:"pump_shotgun", name:"Pump Shotgun", price:27000, img:"guns/pump-shotgun.png" },
    { id:"combat_pdw", name:"Combat PDW", price:35000, img:"guns/combat-pdw.png" },
    { id:"assault_smg", name:"Assault SMG", price:37000, img:"guns/assault-smg.png" },
    { id:"bullpup_rifle", name:"Bullpup Rifle", price:40000, img:"guns/bullpup-rifle.png" },
    { id:"heavy_shotgun", name:"Heavy Shotgun", price:62500, img:"guns/heavy-shotgun.png" },
    { id:"mini_smg", name:"Mini SMG", price:35000, img:"guns/mini-smg.png" },
    { id:"special_carbine", name:"Special Carbine", price:65000, img:"guns/special-carbine.png" },
    { id:"special_carbine_mk2", name:"Special Carbine Mk II", price:70000, img:"guns/special-carbine-mk2.png" },
    { id:"carbine_rifle", name:"Carbine Rifle", price:32000, img:"guns/carbine-rifle.png" },
    { id:"pump_shotgun_mk2", name:"Pump Shotgun Mk II", price:29000, img:"guns/pump-shotgun-mk2.png" },
    { id:"heavy_revolver", name:"Heavy Revolver", price:40000, img:"guns/heavy-revolver.png" }
  ],
  "–•–æ–ª–æ–¥–Ω–∞ –∑–±—Ä–æ—è": [
    { id:"folding_knife", name:"–°–∫–ª–∞–¥–Ω–∏–π –Ω—ñ–∂", price:2000, img:"guns/Stilet.png" },
    { id:"hunting_knife", name:"–ú–∏—Å–ª–∏–≤—Å—å–∫–∏–π –Ω—ñ–∂", price:10000, img:"guns/knife.png" }
  ],
  "–ë–æ—î–ø—Ä–∏–ø–∞—Å–∏": [
    { id:"ammo_9mm", name:"9mm", price:51, img:"guns/9.png" },
    { id:"ammo_12mm", name:"12mm", price:51, img:"guns/12.png" },
    { id:"ammo_556", name:"5.56mm", price:51, img:"guns/5.png" },
    { id:"ammo_762", name:"7.62mm", price:51, img:"guns/7.png" }
  ],
  "–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç": [
    { id:"armor", name:"–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç", price:10000, img:"guns/armo.png" }
  ]
};

const DISCOUNTS_WEAPON = [
  { qty:5,  pct: 2  },
  { qty:10,  pct: 4  },
  { qty:15,  pct: 6  },
  { qty:20,  pct: 8 },
  { qty:25,  pct: 10 },
  { qty:30,  pct: 12 },
  { qty:35,  pct: 14 },
  { qty:40,  pct: 16 }
];

const DISCOUNTS_AMMO = [
  { qty:250,  pct: 4  },
  { qty:500,  pct: 6  },
  { qty:1000, pct: 10 },
  { qty:1500, pct: 15 },
  { qty:2000, pct: 18 },
  { qty:2500, pct: 20 }
];

function money(n){
  const x = Math.round(Number(n) || 0);
  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}
const $ = (id) => document.getElementById(id);

/* ==========================
   DISCORD MENTION
========================== */
function parseDiscordId(input){
  const t = String(input || "").trim();
  if(!t) return null;

  let m = t.match(/^<@!?(\d{6,30})>$/);
  if(m) return m[1];

  m = t.match(/discord\.com\/users\/(\d{6,30})/i);
  if(m) return m[1];

  m = t.match(/^(\d{6,30})$/);
  if(m) return m[1];

  return null;
}

  function discordMentionFromInput(raw){
  const id = parseDiscordId(raw);
  return id ? `<@!${id}>` : "";
}

function syncDiscordMention(){
  const discVal = ($("disc")?.value || "").trim();
  const mention = discordMentionFromInput(discVal);
  const el = $("discordMention");
  if(el) el.value = mention;
}
/* ==========================
   STATE
========================== */
const state = {
  order_id: `CASTRO-${Date.now().toString(36).toUpperCase()}-${Math.random().toString(36).slice(2,6).toUpperCase()}`,
  category: null,
  item: null,
  qty: null,
  discountPct: 0,
  armorColor: "",
  cart: []
};

$("orderId").textContent = state.order_id;

const catIcons = {
  "–í–æ–≥–Ω–µ–ø–∞–ª—å–Ω–∞ –∑–±—Ä–æ—è": "üî´",
  "–•–æ–ª–æ–¥–Ω–∞ –∑–±—Ä–æ—è": "üó°Ô∏è",
  "–ë–æ—î–ø—Ä–∏–ø–∞—Å–∏": "üì¶",
  "–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç": "üõ°Ô∏è"
};

function setStatus(msg){ $("status").textContent = msg; }

/* ==========================
   DISCOUNT HELPERS
========================== */
function getDiscountTableByCategory(cat){
  if(cat === "–ë–æ—î–ø—Ä–∏–ø–∞—Å–∏") return DISCOUNTS_AMMO;
  return DISCOUNTS_WEAPON;
}
function bestDiscountForQty(cat, qty){
  const table = getDiscountTableByCategory(cat) || [];
  let best = { qty: 0, pct: 0 };

  for (const row of table) {
    if (qty >= row.qty) best = row;
  }
  return best;
}
function lineCalc(unitPrice, qty, discountPct){
  const subtotal = unitPrice * qty;
  const disc = Math.floor(subtotal * (discountPct || 0) / 100);
  const total = subtotal - disc;
  return { subtotal, disc, total };
}

/* ==========================
   PERSIST (localStorage)
========================== */
function saveLS(){
  const data = {
    v: 2,
    order_id: state.order_id,
    cart: state.cart,
    form: {
      nick: $("nick").value || "",
      disc: $("disc").value || "",
      delivery: $("delivery").value || "–°–∞–º–æ–≤–∏–≤—ñ–∑",
      note: $("note").value || ""
    }
  };
  try{ localStorage.setItem(LS_KEY, JSON.stringify(data)); }catch{}
}
function loadLS(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return;
    const data = JSON.parse(raw);
    if(!data || data.v !== 2) return;

    if(data.form){
      $("nick").value = data.form.nick || "";
      $("disc").value = data.form.disc || "";
      $("delivery").value = data.form.delivery || "–°–∞–º–æ–≤–∏–≤—ñ–∑";
      $("note").value = data.form.note || "";
    }

    if(Array.isArray(data.cart)){
      state.cart = data.cart
        .filter(x=>x && x.item && x.item.id && x.item.unit_price)
        .map(x=>({
          ...x,
          qty: Math.max(1, Math.floor(Number(x.qty)||1)),
          discount_pct: Math.max(0, Math.floor(Number(x.discount_pct)||0))
        }));
    }
  }catch{}
}

/* ==========================
   CATEGORY / ITEMS
========================== */
function renderCats(){
  const wrap = $("cats");
  wrap.innerHTML = "";
  Object.keys(CATALOG).forEach(cat=>{
    const btn = document.createElement("div");
    btn.className = "chip";
    btn.dataset.cat = cat;
    btn.innerHTML = `${catIcons[cat] || "üìå"} <span>${cat}</span>`;
    btn.onclick = () => selectCategory(cat);
    wrap.appendChild(btn);
  });
}
function selectCategory(cat){
  state.category = cat;
  state.item = null;
  state.qty = null;
  state.discountPct = 0;
  state.armorColor = "";
  $("armorColor").value = "";
  $("qtyCustom").value = "";

  [...$("cats").children].forEach(ch=>{
    ch.classList.toggle("active", ch.dataset.cat === cat);
  });

  $("itemsWrap").style.display = "block";
  $("qtyWrap").style.display = "none";
  $("armorWrap").style.display = (cat === "–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç") ? "block" : "none";

  renderItems();
  updateAll();
  setStatus(`–ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ${cat}\n–¢–µ–ø–µ—Ä –æ–±–µ—Ä–∏ —Ç–æ–≤–∞—Ä.`);
}
function renderItems(){
  const items = CATALOG[state.category] || [];
  const wrap = $("items");
  wrap.innerHTML = "";

  items.forEach(it=>{
    const card = document.createElement("div");
    card.className = "item";
    card.dataset.item = it.id;

    card.innerHTML = `
      <div class="thumb">
        <img alt="${it.name}" src="${it.img}" loading="lazy" />
      </div>
      <div class="itm-body">
        <div class="itm-title">${it.name}</div>
        <div class="price">${money(it.price)}$ <small>/ 1 –æ–¥.</small></div>
      </div>
    `;

    const img = card.querySelector("img");
    img.addEventListener("error", ()=>{
      const thumb = card.querySelector(".thumb");
      thumb.innerHTML = `<div class="muted small">–ù–µ–º–∞—î –∫–∞—Ä—Ç–∏–Ω–∫–∏<br><span class="mono">–ø–µ—Ä–µ–≤—ñ—Ä —à–ª—è—Ö img</span></div>`;
    });

    card.onclick = () => selectItem(it.id);
    wrap.appendChild(card);
  });
}
function selectItem(itemId){
  const it = (CATALOG[state.category] || []).find(x=>x.id===itemId);
  if(!it) return;

  state.item = it;
  state.qty = null;
  state.discountPct = 0;
  $("qtyCustom").value = "";

  [...$("items").children].forEach(c=>{
    c.classList.toggle("active", c.dataset.item === itemId);
  });

  $("qtyWrap").style.display = "block";
  renderQtyPresets();
  updateAll();
  setStatus(`–¢–æ–≤–∞—Ä: ${it.name}\n–û–±–µ—Ä–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —ñ –¥–æ–¥–∞–π —É –∫–æ—à–∏–∫.`);
}

/* ==========================
   QTY
========================== */
function renderQtyPresets(){
  const wrap = $("qtyGrid");
  wrap.innerHTML = "";
  const table = getDiscountTableByCategory(state.category);

  $("qtyHint").textContent = (state.category === "–ë–æ—î–ø—Ä–∏–ø–∞—Å–∏")
    ? "–ó–Ω–∏–∂–∫–∞ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –±–æ—î–ø—Ä–∏–ø–∞—Å—ñ–≤."
    : "–ó–Ω–∏–∂–∫–∞ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –æ–¥–∏–Ω–∏—Ü—å.";

  table.forEach(row=>{
    const b = document.createElement("div");
    b.className = "qty";
    b.dataset.qty = String(row.qty);
    const d = row.pct ? `-${row.pct}%` : "–±–µ–∑ –∑–Ω–∏–∂–∫–∏";
    b.innerHTML = `<div>${row.qty}</div><span class="d">${d}</span>`;
    b.onclick = () => {
      $("qtyCustom").value = "";
      selectQty(row.qty, row.pct);
    };
    wrap.appendChild(b);
  });
}
function selectQty(qty, pct){
  state.qty = qty;
  state.discountPct = pct;

  [...$("qtyGrid").children].forEach(c=>{
    c.classList.toggle("active", Number(c.dataset.qty) === Number(qty));
  });

  updateAll();
  setStatus(`‚úÖ –ì–æ—Ç–æ–≤–æ –¥–æ –¥–æ–¥–∞–≤–∞–Ω–Ω—è\n${state.category} ‚Ä¢ ${state.item?.name}\n–ö—ñ–ª—å–∫—ñ—Å—Ç—å: ${state.qty}\n–ó–Ω–∏–∂–∫–∞: -${state.discountPct}%`);
}
function applyCustomQty(v){
  const n = Math.max(0, Math.floor(Number(String(v).replace(/[^\d]/g,"")) || 0));
  if(!n) return;

  const best = bestDiscountForQty(state.category, n);
  state.qty = n;
  state.discountPct = best.pct || 0;

  [...$("qtyGrid").children].forEach(c=>{
    c.classList.toggle("active", Number(c.dataset.qty) === Number(best.qty));
  });

  updateAll();
  setStatus(`‚úÖ –°–≤–æ—è –∫—ñ–ª—å–∫—ñ—Å—Ç—å\n${state.category} ‚Ä¢ ${state.item?.name}\n–ö—ñ–ª—å–∫—ñ—Å—Ç—å: ${state.qty}\n–ó–Ω–∏–∂–∫–∞: -${state.discountPct}% (–ø–æ—Ä—ñ–≥ ${best.qty})`);
}

/* ==========================
   CART
========================== */
function canAddLine(){
  if(!state.category || !state.item || !state.qty) return false;
  if(state.category === "–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç"){
    const c = $("armorColor").value.trim();
    if(!c) return false;
    state.armorColor = c;
  }
  return true;
}

function addToCart(){
  if(!canAddLine()){
    setStatus("‚ùå –í–∏–±–µ—Ä–∏ —Ç–æ–≤–∞—Ä/–∫—ñ–ª—å–∫—ñ—Å—Ç—å. –î–ª—è –±—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç—É ‚Äî –∑–∞–ø–æ–≤–Ω–∏ –∫–æ–ª—ñ—Ä.");
    return;
  }

  const cat = state.category;
  const it = state.item;
  const qty = Math.max(1, Math.floor(Number(state.qty)||1));
  const armorColor = (cat === "–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç") ? $("armorColor").value.trim() : null;

  const keyMatch = (x) =>
    x.item.id === it.id &&
    x.category === cat &&
    (cat !== "–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç" ? true : (x.armor_color || "").toLowerCase() === (armorColor || "").toLowerCase());

  const existing = state.cart.find(keyMatch);

  if(existing){
    existing.qty += qty;
    const best = bestDiscountForQty(existing.category, existing.qty);
    existing.discount_pct = best.pct || 0;
    const sums = lineCalc(existing.item.unit_price, existing.qty, existing.discount_pct);
    existing.subtotal = sums.subtotal;
    existing.discount_amount = sums.disc;
    existing.total = sums.total;
  }else{
    const best = bestDiscountForQty(cat, qty);
    const pct = best.pct || 0;
    const sums = lineCalc(it.price, qty, pct);

    state.cart.push({
      line_id: `L-${Date.now().toString(36).toUpperCase()}-${Math.random().toString(36).slice(2,6).toUpperCase()}`,
      category: cat,
      item: {
        id: it.id,
        name: it.name,
        unit_price: it.price,
        image_url: ASSET_BASE + it.img
      },
      qty,
      discount_pct: pct,
      subtotal: sums.subtotal,
      discount_amount: sums.disc,
      total: sums.total,
      armor_color: (cat === "–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç") ? armorColor : null
    });
  }

  state.qty = null;
  state.discountPct = 0;
  $("qtyCustom").value = "";
  [...$("qtyGrid").children].forEach(c=>c.classList.remove("active"));

  updateAll();
  setStatus("‚úÖ –î–æ–¥–∞–Ω–æ –≤ –∫–æ—à–∏–∫! –ú–æ–∂–µ—à –¥–æ–¥–∞—Ç–∏ —â–µ –ø–æ–∑–∏—Ü—ñ—ó –∞–±–æ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è.");
}

function recalcLine(line){
  const best = bestDiscountForQty(line.category, line.qty);
  line.discount_pct = best.pct || 0;
  const sums = lineCalc(line.item.unit_price, line.qty, line.discount_pct);
  line.subtotal = sums.subtotal;
  line.discount_amount = sums.disc;
  line.total = sums.total;
}

function changeQty(lineId, delta){
  const line = state.cart.find(x => x.line_id === lineId);
  if(!line) return;
  line.qty = Math.max(1, (Number(line.qty)||1) + delta);
  recalcLine(line);
  updateAll();
}

function setQty(lineId, value){
  const line = state.cart.find(x => x.line_id === lineId);
  if(!line) return;
  const n = Math.max(1, Math.floor(Number(String(value).replace(/[^\d]/g,"")) || 1));
  line.qty = n;
  recalcLine(line);
  updateAll();
}

function splitLine(lineId){
  const line = state.cart.find(x => x.line_id === lineId);
  if(!line) return;

  const copy = JSON.parse(JSON.stringify(line));
  copy.line_id = `L-${Date.now().toString(36).toUpperCase()}-${Math.random().toString(36).slice(2,6).toUpperCase()}`;
  state.cart.push(copy);
  updateAll();
  setStatus("üß© –ü–æ–∑–∏—Ü—ñ—é —Ä–æ–∑–¥—ñ–ª–µ–Ω–æ: —Å—Ç–≤–æ—Ä–µ–Ω–æ –∫–æ–ø—ñ—é —Ä—è–¥–∫–∞.");
}

function removeLine(lineId){
  state.cart = state.cart.filter(x => x.line_id !== lineId);
  updateAll();
  setStatus("üóëÔ∏è –ü–æ–∑–∏—Ü—ñ—é –≤–∏–¥–∞–ª–µ–Ω–æ –∑ –∫–æ—à–∏–∫–∞.");
}

function clearCart(){
  state.cart = [];
  updateAll();
  setStatus("üß∫ –ö–æ—à–∏–∫ –æ—á–∏—â–µ–Ω–æ.");
}

function renderCart(){
  const wrap = $("cart");
  wrap.innerHTML = "";

  if(!state.cart.length){
    wrap.innerHTML = `<div class="cartEmpty">–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π. –î–æ–¥–∞–π —Ç–æ–≤–∞—Ä–∏ –∑–ª—ñ–≤–∞.</div>`;
    return;
  }

  state.cart.forEach(line=>{
    const dtxt = line.discount_pct ? `-${line.discount_pct}% (${money(line.discount_amount)}$)` : `0% (0$)`;
    const armor = (line.category === "–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç" && line.armor_color) ? ` ‚Ä¢ üé® ${line.armor_color}` : "";

    const div = document.createElement("div");
    div.className = "cartItem";
    div.innerHTML = `
      <div class="cartL">
        <div class="cartTitle">${catIcons[line.category] || "üìå"} ${line.item.name}</div>
        <div class="cartMeta">
          <div>${line.category}${armor}</div>
          <div>
            <span class="mono">${money(line.item.unit_price)}$</span>
            √ó
            <span class="mono">${line.qty}</span>
            ‚Ä¢ –∑–Ω–∏–∂–∫–∞: <span class="mono">${dtxt}</span>
          </div>
        </div>
      </div>

      <div class="cartR">
        <div class="cartPrice">${money(line.total)}$</div>

        <div class="qtyPill" title="–ö—ñ–ª—å–∫—ñ—Å—Ç—å">
          <div class="miniBtn" data-act="dec">‚ûñ</div>
          <div class="q mono">${line.qty}</div>
          <div class="miniBtn" data-act="inc">‚ûï</div>
        </div>

        <div class="miniRow">
          <div class="miniBtn" data-act="edit" title="–í–≤–µ—Å—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å">‚úçÔ∏è</div>
          <div class="miniBtn" data-act="split" title="–†–æ–∑–¥—ñ–ª–∏—Ç–∏ (—Å—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ–ø—ñ—é —Ä—è–¥–∫–∞)">üß©</div>
          <div class="miniBtn danger" data-act="del" title="–í–∏–¥–∞–ª–∏—Ç–∏">üóëÔ∏è</div>
        </div>
      </div>
    `;

    div.querySelector('[data-act="dec"]').onclick = () => changeQty(line.line_id, -1);
    div.querySelector('[data-act="inc"]').onclick = () => changeQty(line.line_id, +1);
    div.querySelector('[data-act="del"]').onclick = () => removeLine(line.line_id);
    div.querySelector('[data-act="split"]').onclick = () => splitLine(line.line_id);

    div.querySelector('[data-act="edit"]').onclick = () => {
      const v = prompt("–í–≤–µ–¥–∏ –Ω–æ–≤—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å:", String(line.qty));
      if(v === null) return;
      setQty(line.line_id, v);
    };

    wrap.appendChild(div);
  });
}

function cartTotals(){
  const lines = state.cart.length;
  const subtotal = state.cart.reduce((s,x)=>s+(Number(x.subtotal)||0),0);
  const discount = state.cart.reduce((s,x)=>s+(Number(x.discount_amount)||0),0);
  const total = state.cart.reduce((s,x)=>s+(Number(x.total)||0),0);
  return { lines, subtotal, discount, total };
}

function isValidToSend(){
  // üîê MUST BE LOGGED IN
  if(!window.AUTH_USER) return false;

  const nick = $("nick").value.trim();
  const disc = $("disc").value.trim();
  if(!nick || !disc) return false;
  if(!state.cart.length) return false;
  return true;
}

function updateReceipt(){
  const t = cartTotals();
  $("rLines").textContent = t.lines ? `${t.lines}` : "‚Äî";
  $("rSub").textContent = t.lines ? `${money(t.subtotal)}$` : "‚Äî";
  $("rDisc").textContent = t.lines ? `${money(t.discount)}$` : "‚Äî";
  $("rTotal").textContent = t.lines ? `${money(t.total)}$` : "‚Äî";

  // ‚ö†Ô∏è –í–ê–ñ–õ–ò–í–û: –∫–Ω–æ–ø–∫–∞ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ isValidToSend()
  $("sendBtn").disabled = !isValidToSend();
}
  
function updateAddBtn(){
  $("addToCartBtn").disabled = !canAddLine();
}

function buildDiscordPreview(payload){
  const lines = payload.items.map((x)=>{
    const armor = (x.category === "–ë—Ä–æ–Ω–µ–∂–∏–ª–µ—Ç" && x.armor_color) ? ` | üé® ${x.armor_color}` : "";
    const d = x.discount_pct ? ` (-${x.discount_pct}%)` : "";
    return `‚Ä¢ **${x.item.name}** (${x.category}${armor}) ‚Äî \`${x.qty}\` √ó \`${money(x.item.unit_price)}$\`${d} = **${money(x.total)}$**`;
  });

  const header =
`üßæ **–ù–æ–≤–µ –æ–ø—Ç–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è**
üÜî \`${payload.order_id}\`
üë§ **${payload.buyer.nick_static}**
üí¨ **Discord:** \`${payload.buyer.discord}\`
üöö **–û—Ç—Ä–∏–º–∞–Ω–Ω—è:** ${payload.delivery}`;

  const footer =
`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üì¶ –ü–æ–∑–∏—Ü—ñ–π: **${payload.totals.lines}**
üí∞ –°—É–º–∞: **${money(payload.totals.subtotal)}$**
üí∏ –ó–Ω–∏–∂–∫–∞: **${money(payload.totals.discount_amount)}$**
‚úÖ –î–æ —Å–ø–ª–∞—Ç–∏: **${money(payload.totals.total)}$**
${payload.note ? `üó∫Ô∏è **–î–µ—Ç–∞–ª—ñ:** ${payload.note}` : ""}`.trim();

  return { content: `${header}\n\n${lines.join("\n")}\n\n${footer}`.trim(), lines };
}

let sending = false;

async function sendOrder(){
  // üîê AUTH CHECK
  if (!window.AUTH_USER) {
    setStatus("‚õî –°–ø–æ—á–∞—Ç–∫—É —É–≤—ñ–π–¥–∏ —á–µ—Ä–µ–∑ Discord.");
    return;
  }

  if (sending) return;

  if(!isValidToSend()){
    setStatus("‚ùå –ó–∞–ø–æ–≤–Ω–∏ Nick/Discord —ñ –¥–æ–¥–∞–π —Ö–æ—á–∞ –± 1 –ø–æ–∑–∏—Ü—ñ—é –≤ –∫–æ—à–∏–∫.");
    return;
  }

  sending = true;
  $("sendBtn").disabled = true;

  const nick = $("nick").value.trim();
  const disc = $("disc").value.trim();
  const delivery = $("delivery").value;
  const note = $("note").value.trim();
  const totals = cartTotals();

  const payload = {
    order_id: state.order_id,
    created_at: new Date().toISOString(),
    buyer: {
      nick_static: nick,
      discord: disc,
      discordMention: ($("discordMention")?.value || "").trim()
    },
    items: state.cart.map(x => ({
      line_id: x.line_id,
      category: x.category,
      item: x.item,
      qty: x.qty,
      discount_pct: x.discount_pct,
      subtotal: x.subtotal,
      discount_amount: x.discount_amount,
      total: x.total,
      armor_color: x.armor_color || null
    })),
    totals: {
      lines: totals.lines,
      subtotal: totals.subtotal,
      discount_amount: totals.discount,
      total: totals.total
    },
    delivery,
    note
  };

  payload.discord_preview = buildDiscordPreview(payload);

  setStatus("‚è≥ –í—ñ–¥–ø—Ä–∞–≤–ª—è—é –≤ Discord...");

  const controller = new AbortController();
  const timer = setTimeout(()=>controller.abort(), CONFIG.TIMEOUT_MS);

  try{
    const resp = await fetch(CONFIG.ENDPOINT_URL + "/orders", {
      method: "POST",
      credentials: "include",
      headers: {
        "Content-Type": "application/json",
        "X-Token": CONFIG.X_TOKEN
      },
      body: JSON.stringify(payload),
      signal: controller.signal
    });

    clearTimeout(timer);

    const text = await resp.text().catch(()=> "");
    if(!resp.ok){
      setStatus(`‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞: ${resp.status}\n${text || ""}`.trim());
      sending = false;
      updateReceipt();
      saveLS();
      return;
    }
setStatus(
      `‚úÖ –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ!\norder_id: ${state.order_id}\n–ü–æ–∑–∏—Ü—ñ–π: ${totals.lines}\n–°—É–º–∞ –¥–æ —Å–ø–ª–∞—Ç–∏: ${money(totals.total)}$`
    );

    // –æ—á–∏—Å—Ç–∫–∞ –ø—ñ—Å–ª—è —É—Å–ø—ñ—Ö—É
    state.cart = [];
    updateAll();
    saveLS();

    sending = false;
    updateReceipt();
  }catch(err){
    clearTimeout(timer);
    setStatus(`‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏.\n${String(err)}`);
    sending = false;
    updateReceipt();
    saveLS();
  }
}



function resetPick(){
  state.item = null;
  state.qty = null;
  state.discountPct = 0;
  $("qtyCustom").value = "";
  $("armorColor").value = "";
  $("qtyWrap").style.display = "none";
  [...$("items").children].forEach(c=>c.classList.remove("active"));
  setStatus("‚Ü©Ô∏è –í–∏–±—ñ—Ä —Å–∫–∏–Ω—É—Ç–æ. –û–±–µ—Ä–∏ —Ç–æ–≤–∞—Ä –∑–∞–Ω–æ–≤–æ.");
  updateAll();
}

function updateAll(){
  renderCart();
  updateReceipt();
  updateAddBtn();
  saveLS();
}

/* EVENTS */
$("nick").addEventListener("input", updateAll);
$("disc").addEventListener("input", ()=>{ syncDiscordMention(); updateAll(); });
syncDiscordMention();
$("delivery").addEventListener("change", updateAll);
$("note").addEventListener("input", updateAll);
$("armorColor").addEventListener("input", ()=>{ updateAddBtn(); saveLS(); });

$("qtyCustom").addEventListener("input", (e)=>{
  const v = e.target.value;
  if(!v) return;
  if(!state.category || !state.item) return;
  applyCustomQty(v);
  updateAddBtn();
  saveLS();
});

$("addToCartBtn").addEventListener("click", addToCart);
$("resetPickBtn").addEventListener("click", resetPick);
$("clearCartBtn").addEventListener("click", clearCart);
$("sendBtn").addEventListener("click", sendOrder);

/* INIT */
loadLS();
syncDiscordMention();
renderCats();
updateAll();
</script>

<script>
(async function updateReviewsStats(){
  try{
    const res = await fetch("https://api.family-castro.fun/reviews?t=" + Date.now(), { cache: "no-store" });
    const json = await res.json();
    const reviews = Array.isArray(json?.reviews) ? json.reviews : (Array.isArray(json) ? json : []);

    const count = reviews.length;
    const elCount = document.getElementById("reviewsBadge");
    if(elCount) elCount.textContent = String(count);

    const rated = reviews.filter(r => Number(r.rate) >= 1 && Number(r.rate) <= 5);
    const avg = rated.length ? (rated.reduce((s, x) => s + Number(x.rate), 0) / rated.length) : null;

    const elAvg = document.getElementById("avgRating");
    if(elAvg){
      if(avg){
        const rounded = avg.toFixed(2);
        elAvg.textContent = `‚≠ê –°–µ—Ä–µ–¥–Ω—ñ–π —Ä–µ–π—Ç–∏–Ω–≥: ${rounded} / 5`;
      } else {
        elAvg.textContent = `‚≠ê –°–µ—Ä–µ–¥–Ω—ñ–π —Ä–µ–π—Ç–∏–Ω–≥: ‚Äî / 5`;
      }
    }
  }catch(e){}
})();
</script>

<script src="auth.js" defer></script>
<script src="profile.js" defer></script>

<script>
/* =========================
   üîê AUTH GATE ‚Äî ORDER
   ========================= */

window.AUTH_USER = window.__CASTRO_AUTH__?.user || null;

window.addEventListener("castro-auth", (e) => {
  window.AUTH_USER = e.detail?.user || null;

  // –æ–Ω–æ–≤–ª—é—î–º–æ –∫–Ω–æ–ø–∫—É —ñ —Å—Ç–∞–Ω –±–ª–æ–∫—É–≤–∞–Ω–Ω—è
  if (typeof updateReceipt === "function") updateReceipt();
  if (window.AUTH_USER) unlockForms();
  else lockForms();
});
  
async function checkAuthGate() {
  try {
    const res = await fetch("https://auth.family-castro.fun/auth/me", {
      credentials: "include",
      cache: "no-store"
    });

    const json = await res.json().catch(() => null);
    if (!res.ok || !json?.ok || !json.user) {
      window.AUTH_USER = null;
      lockForms();
      return;
    }

    window.AUTH_USER = json.user;

    // –æ–Ω–æ–≤–∏—Ç–∏ –∫–Ω–æ–ø–∫—É "–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏" –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –ª–æ–≥—ñ–Ω—É
    if (typeof updateReceipt === "function") updateReceipt();

    unlockForms();
  } catch {
    window.AUTH_USER = null;
    lockForms();
  }
}

function lockForms() {
  document.querySelectorAll("#sendBtn, button[type='submit']").forEach(b => {
    b.disabled = true;
    b.classList.add("locked");
  });
  showAuthWarning();
}

function unlockForms() {
  // –Ω–µ —Ä–æ–±–∏–º–æ "unlock all inputs", —Ç—ñ–ª—å–∫–∏ –∫–Ω–æ–ø–∫–∏
  // (—â–æ–± –Ω–µ –ª–∞–º–∞—Ç–∏ —Ç–≤–æ—é –ª–æ–≥—ñ–∫—É required/disabled)
  document.querySelectorAll("#sendBtn, button[type='submit']").forEach(b => {
    // sendBtn –≤—Å–µ –æ–¥–Ω–æ –ø–µ—Ä–µ—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è updateReceipt()
    b.classList.remove("locked");
  });
  hideAuthWarning();
}

function showAuthWarning() {
  if (document.getElementById("auth-warning")) return;

  const div = document.createElement("div");
  div.id = "auth-warning";
  div.innerHTML = `üîê <b>–ü–æ—Ç—Ä—ñ–±–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è</b><br>–£–≤—ñ–π–¥–∏ —á–µ—Ä–µ–∑ Discord, —â–æ–± –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏`;
  div.style.cssText = `
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,.85);
    border: 1px solid rgba(255,255,255,.2);
    color: #fff;
    padding: 12px 16px;
    border-radius: 14px;
    font-weight: 900;
    z-index: 99999;
    backdrop-filter: blur(10px);
    text-align: center;
  `;
  document.body.appendChild(div);
}

function hideAuthWarning() {
  document.getElementById("auth-warning")?.remove();
}

checkAuthGate();
window.addEventListener("focus", checkAuthGate);
</script>
<script>
(function(){
  const loader = document.getElementById("vload");
  if(!loader) return;

  // –°–ø—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ –≤—ñ–¥–µ–æ-—Ñ–æ–Ω –≤ —Ç–≤–æ—ó—Ö —Ä—ñ–∑–Ω–∏—Ö —à–∞–±–ª–æ–Ω–∞—Ö:
  const video =
    document.querySelector(".video-bg video") ||      // join/info/order
    document.querySelector(".hero-bg video") ||       // index
    document.querySelector("video#bgVideo") ||        // order (id —î) :contentReference[oaicite:5]{index=5}
    document.querySelector("video");

  // –Ø–∫—â–æ –≤—ñ–¥–µ–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ ‚Äî –ø—Ä–æ—Å—Ç–æ —Å—Ö–æ–≤–∞—î–º–æ –ª–æ–∞–¥–µ—Ä
  if(!video){
    hide();
    return;
  }

  document.documentElement.classList.add("is-video-loading");
  document.body.classList.add("is-video-loading");

  let done = false;

  // –•–æ–≤–∞—î–º–æ –∫—Ä–∞—Å–∏–≤–æ (—Ä–æ–∑—Å—ñ—é–≤–∞–Ω–Ω—è)
  function hide(){
    if(done) return;
    done = true;

    loader.classList.add("is-hide");
    loader.setAttribute("aria-hidden", "true");
    document.documentElement.classList.remove("is-video-loading");
    document.body.classList.remove("is-video-loading");
  }

  // –Ø–∫—â–æ –≤—ñ–¥–µ–æ –≤–∂–µ –º–∞—î –¥–∞–Ω—ñ ‚Äî –Ω–µ —á–µ–∫–∞—î–º–æ
  if(video.readyState >= 2){
    // readyState 2 = HAVE_CURRENT_DATA
    // –î–∞–º–æ –∫–∞–¥—Ä –∑'—è–≤–∏—Ç–∏—Å—è —ñ —Ö–æ–≤–∞—î–º–æ
    requestAnimationFrame(() => setTimeout(hide, 120));
    return;
  }

  // –ö–æ–ª–∏ –≤—ñ–¥–µ–æ –≥–æ—Ç–æ–≤–µ –ø–æ–∫–∞–∑–∞—Ç–∏ –ø–µ—Ä—à–∏–π –∫–∞–¥—Ä
  const onReady = () => {
    // –î–∞–π –≤—ñ–¥–µ–æ —Ä–µ–∞–ª—å–Ω–æ –ø–æ—á–∞—Ç–∏ —Ä–µ–Ω–¥–µ—Ä
    requestAnimationFrame(() => setTimeout(hide, 120));
  };

  video.addEventListener("loadeddata", onReady, { once: true });
  video.addEventListener("canplay", onReady, { once: true });

  // –ü—ñ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞: –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤—ñ–¥–µ–æ –≥–ª—é—á–∏—Ç—å/–º–µ—Ä–µ–∂–∞ —Å–ª–∞–±–∫–∞ ‚Äî –Ω–µ —Ç—Ä–∏–º–∞—î–º–æ –≤—ñ—á–Ω–æ
  setTimeout(hide, 7000);

  // –Ø–∫—â–æ –≤–∫–ª–∞–¥–∫–∞ —Å—Ö–æ–≤–∞–Ω–∞ ‚Äî –Ω–µ –±–ª–æ–∫—É—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –ª–æ–∞–¥–µ—Ä–æ–º
  document.addEventListener("visibilitychange", () => {
    if(document.hidden) hide();
  });

  // –°–ø—Ä–æ–±—É—î–º–æ "–ø—ñ–¥—à—Ç–æ–≤—Ö–Ω—É—Ç–∏" –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ –º–æ–±—ñ–ª–∫–∞—Ö
  try { video.load(); } catch(e) {}
})();
</script>
  

<script>
(function(){
  function hasProfileIC(){
    const ic = localStorage.getItem("ic");
    const sid = localStorage.getItem("sid");
    return !!(ic && sid);
  }

  function openProfile(){
    if (typeof window.openProfileModal === "function") return window.openProfileModal();
    // fallback: click on auth-user (profile.js binds open on auth-user click)
    document.getElementById("auth-user")?.click?.();
  }

  function renderAuthHint(){
    const text = document.getElementById("authHintText");
    const actions = document.getElementById("authHintActions");
    if(!text || !actions) return;

    const user = window.__CASTRO_AUTH__?.user || null;
    actions.innerHTML = "";

    // not authed
    if(!user){
      text.innerHTML = "‚ö†Ô∏è –ê–≤—Ç–æ—Ä–∏–∑—É–π—Å—è —á–µ—Ä–µ–∑ Discord —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–π –ø—Ä–æ—Ñ—ñ–ª—å (IC –Ω—ñ–∫ + Static ID), —ñ–Ω–∞–∫—à–µ —Ñ–æ—Ä–º–∞ –Ω–µ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç—å—Å—è.";
      actions.innerHTML = `
        <button class="authHint__btn" type="button" onclick="document.getElementById('auth-login')?.click()">üîê –ê–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—å</button>
        <button class="authHint__btn authHint__btn--ghost" type="button" onclick="(${openProfile.__name__||'openProfile'})()">üõ†Ô∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é</button>
      `;
      // Fix: inline can't access local function by name; we will set window.__openProfileHint
      return;
    }

    if(!hasProfileIC()){
      text.innerHTML = "‚ö†Ô∏è –¢–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–π, –∞–ª–µ –ø—Ä–æ—Ñ—ñ–ª—å –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–π. –ó–∞–ø–æ–≤–Ω–∏ IC –Ω—ñ–∫ —Ç–∞ Static ID —É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö –ø—Ä–æ—Ñ—ñ–ª—é.";
      actions.innerHTML = `
        <button class="authHint__btn" type="button" onclick="window.__openProfileHint?.()">üõ†Ô∏è –ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</button>
      `;
      return;
    }

    text.innerHTML = "‚úÖ –ü—Ä–æ—Ñ—ñ–ª—å –≥–æ—Ç–æ–≤–∏–π. –ú–æ–∂–µ—à –ø—Ä–æ–¥–æ–≤–∂—É–≤–∞—Ç–∏.";
  }

  // expose for onclick usage
  window.__openProfileHint = function(){
    if (typeof window.openProfileModal === "function") return window.openProfileModal();
    document.getElementById("auth-user")?.click?.();
  };

  window.addEventListener("castro-auth", renderAuthHint);
  window.addEventListener("castro-profile", renderAuthHint);
  document.addEventListener("DOMContentLoaded", renderAuthHint);
})();
</script>

</body>
</html>
